<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>ALSA project - the C library reference: /test/pcm.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>/test/pcm.c</h1><div class="fragment"><pre class="fragment"><span class="comment">/*</span>
<span class="comment"> *  This small demo sends a simple sinusoidal wave to your speakers.</span>
<span class="comment"> */</span>

<span class="preprocessor">#include &lt;stdio.h&gt;</span>
<span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<span class="preprocessor">#include &lt;string.h&gt;</span>
<span class="preprocessor">#include &lt;sched.h&gt;</span>
<span class="preprocessor">#include &lt;errno.h&gt;</span>
<span class="preprocessor">#include &lt;getopt.h&gt;</span>
<span class="preprocessor">#include &quot;../include/asoundlib.h&quot;</span>
<span class="preprocessor">#include &lt;sys/time.h&gt;</span>
<span class="preprocessor">#include &lt;math.h&gt;</span>

<span class="keyword">static</span> <span class="keywordtype">char</span> *device = <span class="stringliteral">&quot;plughw:0,0&quot;</span>;                     <span class="comment">/* playback device */</span>
<span class="keyword">static</span> <a class="code" href="group___p_c_m.html#gaa14b7f26877a812acbb39811364177f8">snd_pcm_format_t</a> format = <a name="a0"></a><a class="code" href="group___p_c_m.html#ggaa14b7f26877a812acbb39811364177f8aac4470b6be81c22af0cfe528bee4a474">SND_PCM_FORMAT_S16</a>;    <span class="comment">/* sample format */</span>
<span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> rate = 44100;                       <span class="comment">/* stream rate */</span>
<span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> channels = 1;                       <span class="comment">/* count of channels */</span>
<span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> buffer_time = 500000;               <span class="comment">/* ring buffer length in us */</span>
<span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> period_time = 100000;               <span class="comment">/* period time in us */</span>
<span class="keyword">static</span> <span class="keywordtype">double</span> freq = 440;                               <span class="comment">/* sinusoidal wave frequency in Hz */</span>
<span class="keyword">static</span> <span class="keywordtype">int</span> verbose = 0;                                 <span class="comment">/* verbose flag */</span>
<span class="keyword">static</span> <span class="keywordtype">int</span> resample = 1;                                <span class="comment">/* enable alsa-lib resampling */</span>
<span class="keyword">static</span> <span class="keywordtype">int</span> period_event = 0;                            <span class="comment">/* produce poll event after each period */</span>

<span class="keyword">static</span> <a name="a1"></a><a class="code" href="group___p_c_m.html#ga71cdfa37e258d2210b8bd0216bf0c36c">snd_pcm_sframes_t</a> buffer_size;
<span class="keyword">static</span> <a class="code" href="group___p_c_m.html#ga71cdfa37e258d2210b8bd0216bf0c36c">snd_pcm_sframes_t</a> period_size;
<span class="keyword">static</span> <a name="a2"></a><a class="code" href="group___output.html#ga49729cc6454539495c1f5b6e95cd474a" title="Internal structure for an output object.">snd_output_t</a> *output = NULL;

<span class="keyword">static</span> <span class="keywordtype">void</span> generate_sine(<span class="keyword">const</span> <a name="_a3"></a><a class="code" href="structsnd__pcm__channel__area__t.html">snd_pcm_channel_area_t</a> *areas, 
                          <a name="a4"></a><a class="code" href="group___p_c_m.html#gab01fcfe9b97382a8d3f2027c664b8b8a">snd_pcm_uframes_t</a> offset,
                          <span class="keywordtype">int</span> count, <span class="keywordtype">double</span> *_phase)
{
        <span class="keyword">static</span> <span class="keywordtype">double</span> max_phase = 2. * M_PI;
        <span class="keywordtype">double</span> phase = *_phase;
        <span class="keywordtype">double</span> step = max_phase*freq/(double)rate;
        <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *samples[channels];
        <span class="keywordtype">int</span> steps[channels];
        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> chn;
        <span class="keywordtype">int</span> format_bits = <a name="a5"></a><a class="code" href="group___p_c_m___helpers.html#ga8d4e07f2d68cc16f607857ed8a222a29" title="Return nominal bits per a PCM sample.">snd_pcm_format_width</a>(format);
        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> maxval = (1 &lt;&lt; (format_bits - 1)) - 1;
        <span class="keywordtype">int</span> bps = format_bits / 8;  <span class="comment">/* bytes per sample */</span>
        <span class="keywordtype">int</span> phys_bps = <a name="a6"></a><a class="code" href="group___p_c_m___helpers.html#gaa3e0ff7560342e5af2b5c7bd2d63a307" title="Return bits needed to store a PCM sample.">snd_pcm_format_physical_width</a>(format) / 8;
        <span class="keywordtype">int</span> big_endian = <a name="a7"></a><a class="code" href="group___p_c_m___helpers.html#ga3c0c224b8f67e73cf2447bee0110f760" title="Return endian info for a PCM sample format.">snd_pcm_format_big_endian</a>(format) == 1;
        <span class="keywordtype">int</span> to_unsigned = <a name="a8"></a><a class="code" href="group___p_c_m___helpers.html#ga8cd4e3ecc963942457e3b1b6f7661a90" title="Return sign info for a PCM sample linear format.">snd_pcm_format_unsigned</a>(format) == 1;
        <span class="keywordtype">int</span> is_float = (format == <a name="a9"></a><a class="code" href="group___p_c_m.html#ggaa14b7f26877a812acbb39811364177f8a083f32474a84d344e0da496470085c8f">SND_PCM_FORMAT_FLOAT_LE</a> ||
                        format == <a name="a10"></a><a class="code" href="group___p_c_m.html#ggaa14b7f26877a812acbb39811364177f8ab24eac408b0d2ae6b5f68ed3a7cd2d75">SND_PCM_FORMAT_FLOAT_BE</a>);

        <span class="comment">/* verify and prepare the contents of areas */</span>
        <span class="keywordflow">for</span> (chn = 0; chn &lt; channels; chn++) {
                <span class="keywordflow">if</span> ((areas[chn].first % 8) != 0) {
                        printf(<span class="stringliteral">&quot;areas[%i].first == %i, aborting...\n&quot;</span>, chn, areas[chn].first);
                        exit(EXIT_FAILURE);
                }
                samples[chn] = <span class="comment">/*(signed short *)*/</span>(((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)areas[chn].addr) + (areas[chn].<a name="a11"></a><a class="code" href="structsnd__pcm__channel__area__t.html#aba2a69e0d221beaa9f2f115254cb515a">first</a> / 8));
                <span class="keywordflow">if</span> ((areas[chn].step % 16) != 0) {
                        printf(<span class="stringliteral">&quot;areas[%i].step == %i, aborting...\n&quot;</span>, chn, areas[chn].step);
                        exit(EXIT_FAILURE);
                }
                steps[chn] = areas[chn].<a name="a12"></a><a class="code" href="structsnd__pcm__channel__area__t.html#aedbe57a917a0ba24bf1f526387e6e43a">step</a> / 8;
                samples[chn] += offset * steps[chn];
        }
        <span class="comment">/* fill the channel areas */</span>
        <span class="keywordflow">while</span> (count-- &gt; 0) {
                <span class="keyword">union </span>{
                        <span class="keywordtype">float</span> f;
                        <span class="keywordtype">int</span> i;
                } fval;
                <span class="keywordtype">int</span> res, i;
                <span class="keywordflow">if</span> (is_float) {
                        fval.f = sin(phase) * maxval;
                        res = fval.i;
                } <span class="keywordflow">else</span>
                        res = sin(phase) * maxval;
                <span class="keywordflow">if</span> (to_unsigned)
                        res ^= 1U &lt;&lt; (format_bits - 1);
                <span class="keywordflow">for</span> (chn = 0; chn &lt; channels; chn++) {
                        <span class="comment">/* Generate data in native endian format */</span>
                        <span class="keywordflow">if</span> (big_endian) {
                                <span class="keywordflow">for</span> (i = 0; i &lt; bps; i++)
                                        *(samples[chn] + phys_bps - 1 - i) = (res &gt;&gt; i * 8) &amp; 0xff;
                        } <span class="keywordflow">else</span> {
                                <span class="keywordflow">for</span> (i = 0; i &lt; bps; i++)
                                        *(samples[chn] + i) = (res &gt;&gt;  i * 8) &amp; 0xff;
                        }
                        samples[chn] += steps[chn];
                }
                phase += step;
                <span class="keywordflow">if</span> (phase &gt;= max_phase)
                        phase -= max_phase;
        }
        *_phase = phase;
}

<span class="keyword">static</span> <span class="keywordtype">int</span> set_hwparams(<a name="a13"></a><a class="code" href="group___p_c_m.html#ga919e634deecd855b6e2e15174e70d3ea">snd_pcm_t</a> *handle,
                        <a name="a14"></a><a class="code" href="group___p_c_m.html#ga65c737127994f0a980edad744e36dc40">snd_pcm_hw_params_t</a> *params,
                        <a class="code" href="group___p_c_m.html#ga661221ba5e8f1d6eaf4ab8e2da57cc1a">snd_pcm_access_t</a> access)
{
        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> rrate;
        <a class="code" href="group___p_c_m.html#gab01fcfe9b97382a8d3f2027c664b8b8a">snd_pcm_uframes_t</a> size;
        <span class="keywordtype">int</span> err, dir;

        <span class="comment">/* choose all parameters */</span>
        err = <a name="a15"></a><a class="code" href="group___p_c_m___h_w___params.html#ga6e2dd8efbb7a4084bd05e6cc458d84f7" title="Fill params with a full configuration space for a PCM.">snd_pcm_hw_params_any</a>(handle, params);
        <span class="keywordflow">if</span> (err &lt; 0) {
                printf(<span class="stringliteral">&quot;Broken configuration for playback: no configurations available: %s\n&quot;</span>, <a name="a16"></a><a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                <span class="keywordflow">return</span> err;
        }
        <span class="comment">/* set hardware resampling */</span>
        err = <a name="a17"></a><a class="code" href="group___p_c_m___h_w___params.html#ga82eecc0e27a94ce0caa195cc3765536c" title="Restrict a configuration space to contain only real hardware rates.">snd_pcm_hw_params_set_rate_resample</a>(handle, params, resample);
        <span class="keywordflow">if</span> (err &lt; 0) {
                printf(<span class="stringliteral">&quot;Resampling setup failed for playback: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                <span class="keywordflow">return</span> err;
        }
        <span class="comment">/* set the interleaved read/write format */</span>
        err = <a name="a18"></a><a class="code" href="group___p_c_m___h_w___params.html#ga4c8f1c632931923531ca68ee048a8de8" title="Restrict a configuration space to contain only one access type.">snd_pcm_hw_params_set_access</a>(handle, params, access);
        <span class="keywordflow">if</span> (err &lt; 0) {
                printf(<span class="stringliteral">&quot;Access type not available for playback: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                <span class="keywordflow">return</span> err;
        }
        <span class="comment">/* set the sample format */</span>
        err = <a name="a19"></a><a class="code" href="group___p_c_m___h_w___params.html#ga6014e0e1ec7934f8c745290e83e59199" title="Restrict a configuration space to contain only one format.">snd_pcm_hw_params_set_format</a>(handle, params, format);
        <span class="keywordflow">if</span> (err &lt; 0) {
                printf(<span class="stringliteral">&quot;Sample format not available for playback: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                <span class="keywordflow">return</span> err;
        }
        <span class="comment">/* set the count of channels */</span>
        err = <a name="a20"></a><a class="code" href="group___p_c_m___h_w___params.html#ga3a5b2a05c5d9869cc743dac71c0d270a" title="Restrict a configuration space to contain only one channels count.">snd_pcm_hw_params_set_channels</a>(handle, params, channels);
        <span class="keywordflow">if</span> (err &lt; 0) {
                printf(<span class="stringliteral">&quot;Channels count (%i) not available for playbacks: %s\n&quot;</span>, channels, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                <span class="keywordflow">return</span> err;
        }
        <span class="comment">/* set the stream rate */</span>
        rrate = rate;
        err = <a name="a21"></a><a class="code" href="group___p_c_m___h_w___params.html#ga39124280d06ce63092a77e3f25ddd6ee" title="Restrict a configuration space to have rate nearest to a target.">snd_pcm_hw_params_set_rate_near</a>(handle, params, &amp;rrate, 0);
        <span class="keywordflow">if</span> (err &lt; 0) {
                printf(<span class="stringliteral">&quot;Rate %iHz not available for playback: %s\n&quot;</span>, rate, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                <span class="keywordflow">return</span> err;
        }
        <span class="keywordflow">if</span> (rrate != rate) {
                printf(<span class="stringliteral">&quot;Rate doesn&apos;t match (requested %iHz, get %iHz)\n&quot;</span>, rate, err);
                <span class="keywordflow">return</span> -EINVAL;
        }
        <span class="comment">/* set the buffer time */</span>
        err = <a name="a22"></a><a class="code" href="group___p_c_m___h_w___params.html#ga3bc1b188576d6d2daae9c56024813d10" title="Restrict a configuration space to have buffer time nearest to a target.">snd_pcm_hw_params_set_buffer_time_near</a>(handle, params, &amp;buffer_time, &amp;dir);
        <span class="keywordflow">if</span> (err &lt; 0) {
                printf(<span class="stringliteral">&quot;Unable to set buffer time %i for playback: %s\n&quot;</span>, buffer_time, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                <span class="keywordflow">return</span> err;
        }
        err = <a name="a23"></a><a class="code" href="group___p_c_m___h_w___params.html#gab6556fcaaf926360d2064044a6f6cfb4" title="Extract buffer size from a configuration space.">snd_pcm_hw_params_get_buffer_size</a>(params, &amp;size);
        <span class="keywordflow">if</span> (err &lt; 0) {
                printf(<span class="stringliteral">&quot;Unable to get buffer size for playback: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                <span class="keywordflow">return</span> err;
        }
        buffer_size = size;
        <span class="comment">/* set the period time */</span>
        err = <a name="a24"></a><a class="code" href="group___p_c_m___h_w___params.html#gaa22d4f917c300b0c1f47b348c23705a4" title="Restrict a configuration space to have period time nearest to a target.">snd_pcm_hw_params_set_period_time_near</a>(handle, params, &amp;period_time, &amp;dir);
        <span class="keywordflow">if</span> (err &lt; 0) {
                printf(<span class="stringliteral">&quot;Unable to set period time %i for playback: %s\n&quot;</span>, period_time, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                <span class="keywordflow">return</span> err;
        }
        err = <a name="a25"></a><a class="code" href="group___p_c_m___h_w___params.html#gaba48ea189171536f9793e0d99e6db5e0" title="Extract period size from a configuration space.">snd_pcm_hw_params_get_period_size</a>(params, &amp;size, &amp;dir);
        <span class="keywordflow">if</span> (err &lt; 0) {
                printf(<span class="stringliteral">&quot;Unable to get period size for playback: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                <span class="keywordflow">return</span> err;
        }
        period_size = size;
        <span class="comment">/* write the parameters to device */</span>
        err = <a name="a26"></a><a class="code" href="group___p_c_m.html#ga1ca0dc120a484965e26cabf966502330" title="Install one PCM hardware configuration chosen from a configuration space and snd_pcm_prepare...">snd_pcm_hw_params</a>(handle, params);
        <span class="keywordflow">if</span> (err &lt; 0) {
                printf(<span class="stringliteral">&quot;Unable to set hw params for playback: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                <span class="keywordflow">return</span> err;
        }
        <span class="keywordflow">return</span> 0;
}

<span class="keyword">static</span> <span class="keywordtype">int</span> set_swparams(<a class="code" href="group___p_c_m.html#ga919e634deecd855b6e2e15174e70d3ea">snd_pcm_t</a> *handle, <a name="a27"></a><a class="code" href="group___p_c_m.html#ga7e082d9ea701709270b0674a0be23b09">snd_pcm_sw_params_t</a> *swparams)
{
        <span class="keywordtype">int</span> err;

        <span class="comment">/* get the current swparams */</span>
        err = <a name="a28"></a><a class="code" href="group___p_c_m.html#ga61c5495ffb44c75aaa595e85512d28de" title="Return current software configuration for a PCM.">snd_pcm_sw_params_current</a>(handle, swparams);
        <span class="keywordflow">if</span> (err &lt; 0) {
                printf(<span class="stringliteral">&quot;Unable to determine current swparams for playback: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                <span class="keywordflow">return</span> err;
        }
        <span class="comment">/* start the transfer when the buffer is almost full: */</span>
        <span class="comment">/* (buffer_size / avail_min) * avail_min */</span>
        err = <a name="a29"></a><a class="code" href="group___p_c_m___s_w___params.html#ga1d338f1f7e33b7a6d0f9a8f61f87f057" title="Set start threshold inside a software configuration container.">snd_pcm_sw_params_set_start_threshold</a>(handle, swparams, (buffer_size / period_size) * period_size);
        <span class="keywordflow">if</span> (err &lt; 0) {
                printf(<span class="stringliteral">&quot;Unable to set start threshold mode for playback: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                <span class="keywordflow">return</span> err;
        }
        <span class="comment">/* allow the transfer when at least period_size samples can be processed */</span>
        <span class="comment">/* or disable this mechanism when period event is enabled (aka interrupt like style processing) */</span>
        err = <a name="a30"></a><a class="code" href="group___p_c_m___s_w___params.html#ga79b12cbbd309750156261e7f5a39167b" title="Set avail min inside a software configuration container.">snd_pcm_sw_params_set_avail_min</a>(handle, swparams, period_event ? buffer_size : period_size);
        <span class="keywordflow">if</span> (err &lt; 0) {
                printf(<span class="stringliteral">&quot;Unable to set avail min for playback: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                <span class="keywordflow">return</span> err;
        }
        <span class="comment">/* enable period events when requested */</span>
        <span class="keywordflow">if</span> (period_event) {
                err = <a name="a31"></a><a class="code" href="group___p_c_m___s_w___params.html#gaf62ce50d6242b4f4dc9d6534a97e5c09" title="Set period event inside a software configuration container.">snd_pcm_sw_params_set_period_event</a>(handle, swparams, 1);
                <span class="keywordflow">if</span> (err &lt; 0) {
                        printf(<span class="stringliteral">&quot;Unable to set period event: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                        <span class="keywordflow">return</span> err;
                }
        }
        <span class="comment">/* write the parameters to the playback device */</span>
        err = <a name="a32"></a><a class="code" href="group___p_c_m.html#ga891ccaeea2c685a533b61b5fa0493974" title="Install PCM software configuration defined by params.">snd_pcm_sw_params</a>(handle, swparams);
        <span class="keywordflow">if</span> (err &lt; 0) {
                printf(<span class="stringliteral">&quot;Unable to set sw params for playback: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                <span class="keywordflow">return</span> err;
        }
        <span class="keywordflow">return</span> 0;
}

<span class="comment">/*</span>
<span class="comment"> *   Underrun and suspend recovery</span>
<span class="comment"> */</span>
 
<span class="keyword">static</span> <span class="keywordtype">int</span> xrun_recovery(<a class="code" href="group___p_c_m.html#ga919e634deecd855b6e2e15174e70d3ea">snd_pcm_t</a> *handle, <span class="keywordtype">int</span> err)
{
        <span class="keywordflow">if</span> (verbose)
                printf(<span class="stringliteral">&quot;stream recovery\n&quot;</span>);
        <span class="keywordflow">if</span> (err == -EPIPE) {    <span class="comment">/* under-run */</span>
                err = <a name="a33"></a><a class="code" href="group___p_c_m.html#ga788d05de75f2d536f8443cb0306754d0" title="Prepare PCM for use.">snd_pcm_prepare</a>(handle);
                <span class="keywordflow">if</span> (err &lt; 0)
                        printf(<span class="stringliteral">&quot;Can&apos;t recovery from underrun, prepare failed: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                <span class="keywordflow">return</span> 0;
        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (err == -ESTRPIPE) {
                <span class="keywordflow">while</span> ((err = <a name="a34"></a><a class="code" href="group___p_c_m.html#ga13083ce2209aab9ea73831610bc61ab1" title="Resume from suspend, no samples are lost.">snd_pcm_resume</a>(handle)) == -EAGAIN)
                        sleep(1);       <span class="comment">/* wait until the suspend flag is released */</span>
                <span class="keywordflow">if</span> (err &lt; 0) {
                        err = <a class="code" href="group___p_c_m.html#ga788d05de75f2d536f8443cb0306754d0" title="Prepare PCM for use.">snd_pcm_prepare</a>(handle);
                        <span class="keywordflow">if</span> (err &lt; 0)
                                printf(<span class="stringliteral">&quot;Can&apos;t recovery from suspend, prepare failed: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                }
                <span class="keywordflow">return</span> 0;
        }
        <span class="keywordflow">return</span> err;
}

<span class="comment">/*</span>
<span class="comment"> *   Transfer method - write only</span>
<span class="comment"> */</span>

<span class="keyword">static</span> <span class="keywordtype">int</span> write_loop(<a class="code" href="group___p_c_m.html#ga919e634deecd855b6e2e15174e70d3ea">snd_pcm_t</a> *handle,
                      <span class="keywordtype">signed</span> <span class="keywordtype">short</span> *samples,
                      <a class="code" href="structsnd__pcm__channel__area__t.html">snd_pcm_channel_area_t</a> *areas)
{
        <span class="keywordtype">double</span> phase = 0;
        <span class="keywordtype">signed</span> <span class="keywordtype">short</span> *ptr;
        <span class="keywordtype">int</span> err, cptr;

        <span class="keywordflow">while</span> (1) {
                generate_sine(areas, 0, period_size, &amp;phase);
                ptr = samples;
                cptr = period_size;
                <span class="keywordflow">while</span> (cptr &gt; 0) {
                        err = <a name="a35"></a><a class="code" href="group___p_c_m.html#gabc748a500743713eafa960c7d104ca6f" title="Write interleaved frames to a PCM.">snd_pcm_writei</a>(handle, ptr, cptr);
                        <span class="keywordflow">if</span> (err == -EAGAIN)
                                <span class="keywordflow">continue</span>;
                        <span class="keywordflow">if</span> (err &lt; 0) {
                                <span class="keywordflow">if</span> (xrun_recovery(handle, err) &lt; 0) {
                                        printf(<span class="stringliteral">&quot;Write error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                                        exit(EXIT_FAILURE);
                                }
                                <span class="keywordflow">break</span>;  <span class="comment">/* skip one period */</span>
                        }
                        ptr += err * channels;
                        cptr -= err;
                }
        }
}
 
<span class="comment">/*</span>
<span class="comment"> *   Transfer method - write and wait for room in buffer using poll</span>
<span class="comment"> */</span>

<span class="keyword">static</span> <span class="keywordtype">int</span> wait_for_poll(<a class="code" href="group___p_c_m.html#ga919e634deecd855b6e2e15174e70d3ea">snd_pcm_t</a> *handle, <span class="keyword">struct</span> pollfd *ufds, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> count)
{
        <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> revents;

        <span class="keywordflow">while</span> (1) {
                poll(ufds, count, -1);
                <a name="a36"></a><a class="code" href="group___p_c_m.html#ga7e561f305702c6f52dab49b6c84f7df7" title="get returned events from poll descriptors">snd_pcm_poll_descriptors_revents</a>(handle, ufds, count, &amp;revents);
                <span class="keywordflow">if</span> (revents &amp; POLLERR)
                        <span class="keywordflow">return</span> -EIO;
                <span class="keywordflow">if</span> (revents &amp; POLLOUT)
                        <span class="keywordflow">return</span> 0;
        }
}

<span class="keyword">static</span> <span class="keywordtype">int</span> write_and_poll_loop(<a class="code" href="group___p_c_m.html#ga919e634deecd855b6e2e15174e70d3ea">snd_pcm_t</a> *handle,
                               <span class="keywordtype">signed</span> <span class="keywordtype">short</span> *samples,
                               <a class="code" href="structsnd__pcm__channel__area__t.html">snd_pcm_channel_area_t</a> *areas)
{
        <span class="keyword">struct </span>pollfd *ufds;
        <span class="keywordtype">double</span> phase = 0;
        <span class="keywordtype">signed</span> <span class="keywordtype">short</span> *ptr;
        <span class="keywordtype">int</span> err, count, cptr, init;

        count = <a name="a37"></a><a class="code" href="group___p_c_m.html#gac7f4cdb1c930b8d343714f60afa02fc4" title="get count of poll descriptors for PCM handle">snd_pcm_poll_descriptors_count</a> (handle);
        <span class="keywordflow">if</span> (count &lt;= 0) {
                printf(<span class="stringliteral">&quot;Invalid poll descriptors count\n&quot;</span>);
                <span class="keywordflow">return</span> count;
        }

        ufds = malloc(<span class="keyword">sizeof</span>(<span class="keyword">struct</span> pollfd) * count);
        <span class="keywordflow">if</span> (ufds == NULL) {
                printf(<span class="stringliteral">&quot;No enough memory\n&quot;</span>);
                <span class="keywordflow">return</span> -ENOMEM;
        }
        <span class="keywordflow">if</span> ((err = <a name="a38"></a><a class="code" href="group___p_c_m.html#ga742e8705f6992fd0e36efc868e574f01" title="get poll descriptors">snd_pcm_poll_descriptors</a>(handle, ufds, count)) &lt; 0) {
                printf(<span class="stringliteral">&quot;Unable to obtain poll descriptors for playback: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                <span class="keywordflow">return</span> err;
        }

        init = 1;
        <span class="keywordflow">while</span> (1) {
                <span class="keywordflow">if</span> (!init) {
                        err = wait_for_poll(handle, ufds, count);
                        <span class="keywordflow">if</span> (err &lt; 0) {
                                <span class="keywordflow">if</span> (<a name="a39"></a><a class="code" href="group___p_c_m.html#ga87896f6f17020fc19835790369e7ce75" title="Return PCM state.">snd_pcm_state</a>(handle) == <a name="a40"></a><a class="code" href="group___p_c_m.html#gga61ac499cb3701ce536d4d83725908860ab63b5b90201110cd586b686355fd5d83">SND_PCM_STATE_XRUN</a> ||
                                    <a class="code" href="group___p_c_m.html#ga87896f6f17020fc19835790369e7ce75" title="Return PCM state.">snd_pcm_state</a>(handle) == <a name="a41"></a><a class="code" href="group___p_c_m.html#gga61ac499cb3701ce536d4d83725908860a79a05b6b619f88e153d50d9daf2e84bf">SND_PCM_STATE_SUSPENDED</a>) {
                                        err = <a class="code" href="group___p_c_m.html#ga87896f6f17020fc19835790369e7ce75" title="Return PCM state.">snd_pcm_state</a>(handle) == <a class="code" href="group___p_c_m.html#gga61ac499cb3701ce536d4d83725908860ab63b5b90201110cd586b686355fd5d83">SND_PCM_STATE_XRUN</a> ? -EPIPE : -ESTRPIPE;
                                        <span class="keywordflow">if</span> (xrun_recovery(handle, err) &lt; 0) {
                                                printf(<span class="stringliteral">&quot;Write error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                                                exit(EXIT_FAILURE);
                                        }
                                        init = 1;
                                } <span class="keywordflow">else</span> {
                                        printf(<span class="stringliteral">&quot;Wait for poll failed\n&quot;</span>);
                                        <span class="keywordflow">return</span> err;
                                }
                        }
                }

                generate_sine(areas, 0, period_size, &amp;phase);
                ptr = samples;
                cptr = period_size;
                <span class="keywordflow">while</span> (cptr &gt; 0) {
                        err = <a class="code" href="group___p_c_m.html#gabc748a500743713eafa960c7d104ca6f" title="Write interleaved frames to a PCM.">snd_pcm_writei</a>(handle, ptr, cptr);
                        <span class="keywordflow">if</span> (err &lt; 0) {
                                <span class="keywordflow">if</span> (xrun_recovery(handle, err) &lt; 0) {
                                        printf(<span class="stringliteral">&quot;Write error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                                        exit(EXIT_FAILURE);
                                }
                                init = 1;
                                <span class="keywordflow">break</span>;  <span class="comment">/* skip one period */</span>
                        }
                        <span class="keywordflow">if</span> (<a class="code" href="group___p_c_m.html#ga87896f6f17020fc19835790369e7ce75" title="Return PCM state.">snd_pcm_state</a>(handle) == <a name="a42"></a><a class="code" href="group___p_c_m.html#gga61ac499cb3701ce536d4d83725908860a86f6fbc796881f19fde0e1957f878147">SND_PCM_STATE_RUNNING</a>)
                                init = 0;
                        ptr += err * channels;
                        cptr -= err;
                        <span class="keywordflow">if</span> (cptr == 0)
                                <span class="keywordflow">break</span>;
                        <span class="comment">/* it is possible, that the initial buffer cannot store */</span>
                        <span class="comment">/* all data from the last period, so wait awhile */</span>
                        err = wait_for_poll(handle, ufds, count);
                        <span class="keywordflow">if</span> (err &lt; 0) {
                                <span class="keywordflow">if</span> (<a class="code" href="group___p_c_m.html#ga87896f6f17020fc19835790369e7ce75" title="Return PCM state.">snd_pcm_state</a>(handle) == <a class="code" href="group___p_c_m.html#gga61ac499cb3701ce536d4d83725908860ab63b5b90201110cd586b686355fd5d83">SND_PCM_STATE_XRUN</a> ||
                                    <a class="code" href="group___p_c_m.html#ga87896f6f17020fc19835790369e7ce75" title="Return PCM state.">snd_pcm_state</a>(handle) == <a class="code" href="group___p_c_m.html#gga61ac499cb3701ce536d4d83725908860a79a05b6b619f88e153d50d9daf2e84bf">SND_PCM_STATE_SUSPENDED</a>) {
                                        err = <a class="code" href="group___p_c_m.html#ga87896f6f17020fc19835790369e7ce75" title="Return PCM state.">snd_pcm_state</a>(handle) == <a class="code" href="group___p_c_m.html#gga61ac499cb3701ce536d4d83725908860ab63b5b90201110cd586b686355fd5d83">SND_PCM_STATE_XRUN</a> ? -EPIPE : -ESTRPIPE;
                                        <span class="keywordflow">if</span> (xrun_recovery(handle, err) &lt; 0) {
                                                printf(<span class="stringliteral">&quot;Write error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                                                exit(EXIT_FAILURE);
                                        }
                                        init = 1;
                                } <span class="keywordflow">else</span> {
                                        printf(<span class="stringliteral">&quot;Wait for poll failed\n&quot;</span>);
                                        <span class="keywordflow">return</span> err;
                                }
                        }
                }
        }
}

<span class="comment">/*</span>
<span class="comment"> *   Transfer method - asynchronous notification</span>
<span class="comment"> */</span>

<span class="keyword">struct </span>async_private_data {
        <span class="keywordtype">signed</span> <span class="keywordtype">short</span> *samples;
        <a class="code" href="structsnd__pcm__channel__area__t.html">snd_pcm_channel_area_t</a> *areas;
        <span class="keywordtype">double</span> phase;
};

<span class="keyword">static</span> <span class="keywordtype">void</span> async_callback(<a name="a43"></a><a class="code" href="group___global.html#ga8cd9a1d441e9219ca5f2ff04094c7c6d" title="Internal structure for an async notification client handler.">snd_async_handler_t</a> *ahandler)
{
        <a class="code" href="group___p_c_m.html#ga919e634deecd855b6e2e15174e70d3ea">snd_pcm_t</a> *handle = <a name="a44"></a><a class="code" href="group___p_c_m.html#gace4920d5943820c395dab8d9cd4fed0a" title="Return PCM handle related to an async handler.">snd_async_handler_get_pcm</a>(ahandler);
        <span class="keyword">struct </span>async_private_data *data = <a name="a45"></a><a class="code" href="group___global.html#gad9c76588a87918901c6273e6bc98a1bc" title="Returns the private data assigned to an async handler.">snd_async_handler_get_callback_private</a>(ahandler);
        <span class="keywordtype">signed</span> <span class="keywordtype">short</span> *samples = data-&gt;samples;
        <a class="code" href="structsnd__pcm__channel__area__t.html">snd_pcm_channel_area_t</a> *areas = data-&gt;areas;
        <a class="code" href="group___p_c_m.html#ga71cdfa37e258d2210b8bd0216bf0c36c">snd_pcm_sframes_t</a> avail;
        <span class="keywordtype">int</span> err;
        
        avail = <a name="a46"></a><a class="code" href="group___p_c_m.html#ga8bb836bd0c414b59789d51a5f5379c08" title="Return number of frames ready to be read (capture) / written (playback).">snd_pcm_avail_update</a>(handle);
        <span class="keywordflow">while</span> (avail &gt;= period_size) {
                generate_sine(areas, 0, period_size, &amp;data-&gt;phase);
                err = <a class="code" href="group___p_c_m.html#gabc748a500743713eafa960c7d104ca6f" title="Write interleaved frames to a PCM.">snd_pcm_writei</a>(handle, samples, period_size);
                <span class="keywordflow">if</span> (err &lt; 0) {
                        printf(<span class="stringliteral">&quot;Write error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                        exit(EXIT_FAILURE);
                }
                <span class="keywordflow">if</span> (err != period_size) {
                        printf(<span class="stringliteral">&quot;Write error: written %i expected %li\n&quot;</span>, err, period_size);
                        exit(EXIT_FAILURE);
                }
                avail = <a class="code" href="group___p_c_m.html#ga8bb836bd0c414b59789d51a5f5379c08" title="Return number of frames ready to be read (capture) / written (playback).">snd_pcm_avail_update</a>(handle);
        }
}

<span class="keyword">static</span> <span class="keywordtype">int</span> async_loop(<a class="code" href="group___p_c_m.html#ga919e634deecd855b6e2e15174e70d3ea">snd_pcm_t</a> *handle,
                      <span class="keywordtype">signed</span> <span class="keywordtype">short</span> *samples,
                      <a class="code" href="structsnd__pcm__channel__area__t.html">snd_pcm_channel_area_t</a> *areas)
{
        <span class="keyword">struct </span>async_private_data data;
        <a class="code" href="group___global.html#ga8cd9a1d441e9219ca5f2ff04094c7c6d" title="Internal structure for an async notification client handler.">snd_async_handler_t</a> *ahandler;
        <span class="keywordtype">int</span> err, count;

        data.samples = samples;
        data.areas = areas;
        data.phase = 0;
        err = <a name="a47"></a><a class="code" href="group___p_c_m.html#ga5a0c0da6d0d35a3ac9f6a97567ac3b63" title="Add an async handler for a PCM.">snd_async_add_pcm_handler</a>(&amp;ahandler, handle, async_callback, &amp;data);
        <span class="keywordflow">if</span> (err &lt; 0) {
                printf(<span class="stringliteral">&quot;Unable to register async handler\n&quot;</span>);
                exit(EXIT_FAILURE);
        }
        <span class="keywordflow">for</span> (count = 0; count &lt; 2; count++) {
                generate_sine(areas, 0, period_size, &amp;data.phase);
                err = <a class="code" href="group___p_c_m.html#gabc748a500743713eafa960c7d104ca6f" title="Write interleaved frames to a PCM.">snd_pcm_writei</a>(handle, samples, period_size);
                <span class="keywordflow">if</span> (err &lt; 0) {
                        printf(<span class="stringliteral">&quot;Initial write error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                        exit(EXIT_FAILURE);
                }
                <span class="keywordflow">if</span> (err != period_size) {
                        printf(<span class="stringliteral">&quot;Initial write error: written %i expected %li\n&quot;</span>, err, period_size);
                        exit(EXIT_FAILURE);
                }
        }
        <span class="keywordflow">if</span> (<a class="code" href="group___p_c_m.html#ga87896f6f17020fc19835790369e7ce75" title="Return PCM state.">snd_pcm_state</a>(handle) == <a name="a48"></a><a class="code" href="group___p_c_m.html#gga61ac499cb3701ce536d4d83725908860a3eb4a3b75c7d2adb22f1829f3f738b27">SND_PCM_STATE_PREPARED</a>) {
                err = <a name="a49"></a><a class="code" href="group___p_c_m.html#ga6bdb88b68a9d9e66015d770f600c6aea" title="Start a PCM.">snd_pcm_start</a>(handle);
                <span class="keywordflow">if</span> (err &lt; 0) {
                        printf(<span class="stringliteral">&quot;Start error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                        exit(EXIT_FAILURE);
                }
        }

        <span class="comment">/* because all other work is done in the signal handler,</span>
<span class="comment">           suspend the process */</span>
        <span class="keywordflow">while</span> (1) {
                sleep(1);
        }
}

<span class="comment">/*</span>
<span class="comment"> *   Transfer method - asynchronous notification + direct write</span>
<span class="comment"> */</span>

<span class="keyword">static</span> <span class="keywordtype">void</span> async_direct_callback(<a class="code" href="group___global.html#ga8cd9a1d441e9219ca5f2ff04094c7c6d" title="Internal structure for an async notification client handler.">snd_async_handler_t</a> *ahandler)
{
        <a class="code" href="group___p_c_m.html#ga919e634deecd855b6e2e15174e70d3ea">snd_pcm_t</a> *handle = <a class="code" href="group___p_c_m.html#gace4920d5943820c395dab8d9cd4fed0a" title="Return PCM handle related to an async handler.">snd_async_handler_get_pcm</a>(ahandler);
        <span class="keyword">struct </span>async_private_data *data = <a class="code" href="group___global.html#gad9c76588a87918901c6273e6bc98a1bc" title="Returns the private data assigned to an async handler.">snd_async_handler_get_callback_private</a>(ahandler);
        <span class="keyword">const</span> <a class="code" href="structsnd__pcm__channel__area__t.html">snd_pcm_channel_area_t</a> *my_areas;
        <a class="code" href="group___p_c_m.html#gab01fcfe9b97382a8d3f2027c664b8b8a">snd_pcm_uframes_t</a> offset, frames, size;
        <a class="code" href="group___p_c_m.html#ga71cdfa37e258d2210b8bd0216bf0c36c">snd_pcm_sframes_t</a> avail, commitres;
        <a class="code" href="group___p_c_m.html#ga61ac499cb3701ce536d4d83725908860">snd_pcm_state_t</a> state;
        <span class="keywordtype">int</span> first = 0, err;
        
        <span class="keywordflow">while</span> (1) {
                state = <a class="code" href="group___p_c_m.html#ga87896f6f17020fc19835790369e7ce75" title="Return PCM state.">snd_pcm_state</a>(handle);
                <span class="keywordflow">if</span> (state == <a class="code" href="group___p_c_m.html#gga61ac499cb3701ce536d4d83725908860ab63b5b90201110cd586b686355fd5d83">SND_PCM_STATE_XRUN</a>) {
                        err = xrun_recovery(handle, -EPIPE);
                        <span class="keywordflow">if</span> (err &lt; 0) {
                                printf(<span class="stringliteral">&quot;XRUN recovery failed: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                                exit(EXIT_FAILURE);
                        }
                        first = 1;
                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (state == <a class="code" href="group___p_c_m.html#gga61ac499cb3701ce536d4d83725908860a79a05b6b619f88e153d50d9daf2e84bf">SND_PCM_STATE_SUSPENDED</a>) {
                        err = xrun_recovery(handle, -ESTRPIPE);
                        <span class="keywordflow">if</span> (err &lt; 0) {
                                printf(<span class="stringliteral">&quot;SUSPEND recovery failed: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                                exit(EXIT_FAILURE);
                        }
                }
                avail = <a class="code" href="group___p_c_m.html#ga8bb836bd0c414b59789d51a5f5379c08" title="Return number of frames ready to be read (capture) / written (playback).">snd_pcm_avail_update</a>(handle);
                <span class="keywordflow">if</span> (avail &lt; 0) {
                        err = xrun_recovery(handle, avail);
                        <span class="keywordflow">if</span> (err &lt; 0) {
                                printf(<span class="stringliteral">&quot;avail update failed: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                                exit(EXIT_FAILURE);
                        }
                        first = 1;
                        <span class="keywordflow">continue</span>;
                }
                <span class="keywordflow">if</span> (avail &lt; period_size) {
                        <span class="keywordflow">if</span> (first) {
                                first = 0;
                                err = <a class="code" href="group___p_c_m.html#ga6bdb88b68a9d9e66015d770f600c6aea" title="Start a PCM.">snd_pcm_start</a>(handle);
                                <span class="keywordflow">if</span> (err &lt; 0) {
                                        printf(<span class="stringliteral">&quot;Start error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                                        exit(EXIT_FAILURE);
                                }
                        } <span class="keywordflow">else</span> {
                                <span class="keywordflow">break</span>;
                        }
                        <span class="keywordflow">continue</span>;
                }
                size = period_size;
                <span class="keywordflow">while</span> (size &gt; 0) {
                        frames = size;
                        err = <a name="a50"></a><a class="code" href="group___p_c_m___direct.html#ga6d4acf42de554d4d1177fb035d484ea4" title="Application request to access a portion of direct (mmap) area.">snd_pcm_mmap_begin</a>(handle, &amp;my_areas, &amp;offset, &amp;frames);
                        <span class="keywordflow">if</span> (err &lt; 0) {
                                <span class="keywordflow">if</span> ((err = xrun_recovery(handle, err)) &lt; 0) {
                                        printf(<span class="stringliteral">&quot;MMAP begin avail error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                                        exit(EXIT_FAILURE);
                                }
                                first = 1;
                        }
                        generate_sine(my_areas, offset, frames, &amp;data-&gt;phase);
                        commitres = <a name="a51"></a><a class="code" href="group___p_c_m___direct.html#gac306bd13c305825aa39dd9180a3ad520" title="Application has completed the access to area requested with snd_pcm_mmap_begin.">snd_pcm_mmap_commit</a>(handle, offset, frames);
                        <span class="keywordflow">if</span> (commitres &lt; 0 || (<a class="code" href="group___p_c_m.html#gab01fcfe9b97382a8d3f2027c664b8b8a">snd_pcm_uframes_t</a>)commitres != frames) {
                                <span class="keywordflow">if</span> ((err = xrun_recovery(handle, commitres &gt;= 0 ? -EPIPE : commitres)) &lt; 0) {
                                        printf(<span class="stringliteral">&quot;MMAP commit error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                                        exit(EXIT_FAILURE);
                                }
                                first = 1;
                        }
                        size -= frames;
                }
        }
}

<span class="keyword">static</span> <span class="keywordtype">int</span> async_direct_loop(<a class="code" href="group___p_c_m.html#ga919e634deecd855b6e2e15174e70d3ea">snd_pcm_t</a> *handle,
                             <span class="keywordtype">signed</span> <span class="keywordtype">short</span> *samples ATTRIBUTE_UNUSED,
                             <a class="code" href="structsnd__pcm__channel__area__t.html">snd_pcm_channel_area_t</a> *areas ATTRIBUTE_UNUSED)
{
        <span class="keyword">struct </span>async_private_data data;
        <a class="code" href="group___global.html#ga8cd9a1d441e9219ca5f2ff04094c7c6d" title="Internal structure for an async notification client handler.">snd_async_handler_t</a> *ahandler;
        <span class="keyword">const</span> <a class="code" href="structsnd__pcm__channel__area__t.html">snd_pcm_channel_area_t</a> *my_areas;
        <a class="code" href="group___p_c_m.html#gab01fcfe9b97382a8d3f2027c664b8b8a">snd_pcm_uframes_t</a> offset, frames, size;
        <a class="code" href="group___p_c_m.html#ga71cdfa37e258d2210b8bd0216bf0c36c">snd_pcm_sframes_t</a> commitres;
        <span class="keywordtype">int</span> err, count;

        data.samples = NULL;    <span class="comment">/* we do not require the global sample area for direct write */</span>
        data.areas = NULL;      <span class="comment">/* we do not require the global areas for direct write */</span>
        data.phase = 0;
        err = <a class="code" href="group___p_c_m.html#ga5a0c0da6d0d35a3ac9f6a97567ac3b63" title="Add an async handler for a PCM.">snd_async_add_pcm_handler</a>(&amp;ahandler, handle, async_direct_callback, &amp;data);
        <span class="keywordflow">if</span> (err &lt; 0) {
                printf(<span class="stringliteral">&quot;Unable to register async handler\n&quot;</span>);
                exit(EXIT_FAILURE);
        }
        <span class="keywordflow">for</span> (count = 0; count &lt; 2; count++) {
                size = period_size;
                <span class="keywordflow">while</span> (size &gt; 0) {
                        frames = size;
                        err = <a class="code" href="group___p_c_m___direct.html#ga6d4acf42de554d4d1177fb035d484ea4" title="Application request to access a portion of direct (mmap) area.">snd_pcm_mmap_begin</a>(handle, &amp;my_areas, &amp;offset, &amp;frames);
                        <span class="keywordflow">if</span> (err &lt; 0) {
                                <span class="keywordflow">if</span> ((err = xrun_recovery(handle, err)) &lt; 0) {
                                        printf(<span class="stringliteral">&quot;MMAP begin avail error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                                        exit(EXIT_FAILURE);
                                }
                        }
                        generate_sine(my_areas, offset, frames, &amp;data.phase);
                        commitres = <a class="code" href="group___p_c_m___direct.html#gac306bd13c305825aa39dd9180a3ad520" title="Application has completed the access to area requested with snd_pcm_mmap_begin.">snd_pcm_mmap_commit</a>(handle, offset, frames);
                        <span class="keywordflow">if</span> (commitres &lt; 0 || (<a class="code" href="group___p_c_m.html#gab01fcfe9b97382a8d3f2027c664b8b8a">snd_pcm_uframes_t</a>)commitres != frames) {
                                <span class="keywordflow">if</span> ((err = xrun_recovery(handle, commitres &gt;= 0 ? -EPIPE : commitres)) &lt; 0) {
                                        printf(<span class="stringliteral">&quot;MMAP commit error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                                        exit(EXIT_FAILURE);
                                }
                        }
                        size -= frames;
                }
        }
        err = <a class="code" href="group___p_c_m.html#ga6bdb88b68a9d9e66015d770f600c6aea" title="Start a PCM.">snd_pcm_start</a>(handle);
        <span class="keywordflow">if</span> (err &lt; 0) {
                printf(<span class="stringliteral">&quot;Start error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                exit(EXIT_FAILURE);
        }

        <span class="comment">/* because all other work is done in the signal handler,</span>
<span class="comment">           suspend the process */</span>
        <span class="keywordflow">while</span> (1) {
                sleep(1);
        }
}

<span class="comment">/*</span>
<span class="comment"> *   Transfer method - direct write only</span>
<span class="comment"> */</span>

<span class="keyword">static</span> <span class="keywordtype">int</span> direct_loop(<a class="code" href="group___p_c_m.html#ga919e634deecd855b6e2e15174e70d3ea">snd_pcm_t</a> *handle,
                       <span class="keywordtype">signed</span> <span class="keywordtype">short</span> *samples ATTRIBUTE_UNUSED,
                       <a class="code" href="structsnd__pcm__channel__area__t.html">snd_pcm_channel_area_t</a> *areas ATTRIBUTE_UNUSED)
{
        <span class="keywordtype">double</span> phase = 0;
        <span class="keyword">const</span> <a class="code" href="structsnd__pcm__channel__area__t.html">snd_pcm_channel_area_t</a> *my_areas;
        <a class="code" href="group___p_c_m.html#gab01fcfe9b97382a8d3f2027c664b8b8a">snd_pcm_uframes_t</a> offset, frames, size;
        <a class="code" href="group___p_c_m.html#ga71cdfa37e258d2210b8bd0216bf0c36c">snd_pcm_sframes_t</a> avail, commitres;
        <a class="code" href="group___p_c_m.html#ga61ac499cb3701ce536d4d83725908860">snd_pcm_state_t</a> state;
        <span class="keywordtype">int</span> err, first = 1;

        <span class="keywordflow">while</span> (1) {
                state = <a class="code" href="group___p_c_m.html#ga87896f6f17020fc19835790369e7ce75" title="Return PCM state.">snd_pcm_state</a>(handle);
                <span class="keywordflow">if</span> (state == <a class="code" href="group___p_c_m.html#gga61ac499cb3701ce536d4d83725908860ab63b5b90201110cd586b686355fd5d83">SND_PCM_STATE_XRUN</a>) {
                        err = xrun_recovery(handle, -EPIPE);
                        <span class="keywordflow">if</span> (err &lt; 0) {
                                printf(<span class="stringliteral">&quot;XRUN recovery failed: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                                <span class="keywordflow">return</span> err;
                        }
                        first = 1;
                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (state == <a class="code" href="group___p_c_m.html#gga61ac499cb3701ce536d4d83725908860a79a05b6b619f88e153d50d9daf2e84bf">SND_PCM_STATE_SUSPENDED</a>) {
                        err = xrun_recovery(handle, -ESTRPIPE);
                        <span class="keywordflow">if</span> (err &lt; 0) {
                                printf(<span class="stringliteral">&quot;SUSPEND recovery failed: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                                <span class="keywordflow">return</span> err;
                        }
                }
                avail = <a class="code" href="group___p_c_m.html#ga8bb836bd0c414b59789d51a5f5379c08" title="Return number of frames ready to be read (capture) / written (playback).">snd_pcm_avail_update</a>(handle);
                <span class="keywordflow">if</span> (avail &lt; 0) {
                        err = xrun_recovery(handle, avail);
                        <span class="keywordflow">if</span> (err &lt; 0) {
                                printf(<span class="stringliteral">&quot;avail update failed: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                                <span class="keywordflow">return</span> err;
                        }
                        first = 1;
                        <span class="keywordflow">continue</span>;
                }
                <span class="keywordflow">if</span> (avail &lt; period_size) {
                        <span class="keywordflow">if</span> (first) {
                                first = 0;
                                err = <a class="code" href="group___p_c_m.html#ga6bdb88b68a9d9e66015d770f600c6aea" title="Start a PCM.">snd_pcm_start</a>(handle);
                                <span class="keywordflow">if</span> (err &lt; 0) {
                                        printf(<span class="stringliteral">&quot;Start error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                                        exit(EXIT_FAILURE);
                                }
                        } <span class="keywordflow">else</span> {
                                err = <a name="a52"></a><a class="code" href="group___p_c_m.html#gad4d53d58b996a7cd9a5cbf1710b90375" title="Wait for a PCM to become ready.">snd_pcm_wait</a>(handle, -1);
                                <span class="keywordflow">if</span> (err &lt; 0) {
                                        <span class="keywordflow">if</span> ((err = xrun_recovery(handle, err)) &lt; 0) {
                                                printf(<span class="stringliteral">&quot;snd_pcm_wait error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                                                exit(EXIT_FAILURE);
                                        }
                                        first = 1;
                                }
                        }
                        <span class="keywordflow">continue</span>;
                }
                size = period_size;
                <span class="keywordflow">while</span> (size &gt; 0) {
                        frames = size;
                        err = <a class="code" href="group___p_c_m___direct.html#ga6d4acf42de554d4d1177fb035d484ea4" title="Application request to access a portion of direct (mmap) area.">snd_pcm_mmap_begin</a>(handle, &amp;my_areas, &amp;offset, &amp;frames);
                        <span class="keywordflow">if</span> (err &lt; 0) {
                                <span class="keywordflow">if</span> ((err = xrun_recovery(handle, err)) &lt; 0) {
                                        printf(<span class="stringliteral">&quot;MMAP begin avail error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                                        exit(EXIT_FAILURE);
                                }
                                first = 1;
                        }
                        generate_sine(my_areas, offset, frames, &amp;phase);
                        commitres = <a class="code" href="group___p_c_m___direct.html#gac306bd13c305825aa39dd9180a3ad520" title="Application has completed the access to area requested with snd_pcm_mmap_begin.">snd_pcm_mmap_commit</a>(handle, offset, frames);
                        <span class="keywordflow">if</span> (commitres &lt; 0 || (<a class="code" href="group___p_c_m.html#gab01fcfe9b97382a8d3f2027c664b8b8a">snd_pcm_uframes_t</a>)commitres != frames) {
                                <span class="keywordflow">if</span> ((err = xrun_recovery(handle, commitres &gt;= 0 ? -EPIPE : commitres)) &lt; 0) {
                                        printf(<span class="stringliteral">&quot;MMAP commit error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                                        exit(EXIT_FAILURE);
                                }
                                first = 1;
                        }
                        size -= frames;
                }
        }
}
 
<span class="comment">/*</span>
<span class="comment"> *   Transfer method - direct write only using mmap_write functions</span>
<span class="comment"> */</span>

<span class="keyword">static</span> <span class="keywordtype">int</span> direct_write_loop(<a class="code" href="group___p_c_m.html#ga919e634deecd855b6e2e15174e70d3ea">snd_pcm_t</a> *handle,
                             <span class="keywordtype">signed</span> <span class="keywordtype">short</span> *samples,
                             <a class="code" href="structsnd__pcm__channel__area__t.html">snd_pcm_channel_area_t</a> *areas)
{
        <span class="keywordtype">double</span> phase = 0;
        <span class="keywordtype">signed</span> <span class="keywordtype">short</span> *ptr;
        <span class="keywordtype">int</span> err, cptr;

        <span class="keywordflow">while</span> (1) {
                generate_sine(areas, 0, period_size, &amp;phase);
                ptr = samples;
                cptr = period_size;
                <span class="keywordflow">while</span> (cptr &gt; 0) {
                        err = <a name="a53"></a><a class="code" href="group___p_c_m___direct.html#ga5a9ee8e1e764b12da6d54dfa195f7c52" title="Write interleaved frames to a PCM using direct buffer (mmap).">snd_pcm_mmap_writei</a>(handle, ptr, cptr);
                        <span class="keywordflow">if</span> (err == -EAGAIN)
                                <span class="keywordflow">continue</span>;
                        <span class="keywordflow">if</span> (err &lt; 0) {
                                <span class="keywordflow">if</span> (xrun_recovery(handle, err) &lt; 0) {
                                        printf(<span class="stringliteral">&quot;Write error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                                        exit(EXIT_FAILURE);
                                }
                                <span class="keywordflow">break</span>;  <span class="comment">/* skip one period */</span>
                        }
                        ptr += err * channels;
                        cptr -= err;
                }
        }
}
 
<span class="comment">/*</span>
<span class="comment"> *</span>
<span class="comment"> */</span>

<span class="keyword">struct </span>transfer_method {
        <span class="keyword">const</span> <span class="keywordtype">char</span> *name;
        <a class="code" href="group___p_c_m.html#ga661221ba5e8f1d6eaf4ab8e2da57cc1a">snd_pcm_access_t</a> access;
        int (*transfer_loop)(<a class="code" href="group___p_c_m.html#ga919e634deecd855b6e2e15174e70d3ea">snd_pcm_t</a> *handle,
                             <span class="keywordtype">signed</span> <span class="keywordtype">short</span> *samples,
                             <a class="code" href="structsnd__pcm__channel__area__t.html">snd_pcm_channel_area_t</a> *areas);
};

<span class="keyword">static</span> <span class="keyword">struct </span>transfer_method transfer_methods[] = {
        { <span class="stringliteral">&quot;write&quot;</span>, <a name="a54"></a><a class="code" href="group___p_c_m.html#gga661221ba5e8f1d6eaf4ab8e2da57cc1aa72a970ed6e676ab0fd9f3c3d36737e0a">SND_PCM_ACCESS_RW_INTERLEAVED</a>, write_loop },
        { <span class="stringliteral">&quot;write_and_poll&quot;</span>, <a class="code" href="group___p_c_m.html#gga661221ba5e8f1d6eaf4ab8e2da57cc1aa72a970ed6e676ab0fd9f3c3d36737e0a">SND_PCM_ACCESS_RW_INTERLEAVED</a>, write_and_poll_loop },
        { <span class="stringliteral">&quot;async&quot;</span>, <a class="code" href="group___p_c_m.html#gga661221ba5e8f1d6eaf4ab8e2da57cc1aa72a970ed6e676ab0fd9f3c3d36737e0a">SND_PCM_ACCESS_RW_INTERLEAVED</a>, async_loop },
        { <span class="stringliteral">&quot;async_direct&quot;</span>, <a name="a55"></a><a class="code" href="group___p_c_m.html#gga661221ba5e8f1d6eaf4ab8e2da57cc1aa90a5dea527c5ae9a53f1448beb2dee6f">SND_PCM_ACCESS_MMAP_INTERLEAVED</a>, async_direct_loop },
        { <span class="stringliteral">&quot;direct_interleaved&quot;</span>, <a class="code" href="group___p_c_m.html#gga661221ba5e8f1d6eaf4ab8e2da57cc1aa90a5dea527c5ae9a53f1448beb2dee6f">SND_PCM_ACCESS_MMAP_INTERLEAVED</a>, direct_loop },
        { <span class="stringliteral">&quot;direct_noninterleaved&quot;</span>, <a name="a56"></a><a class="code" href="group___p_c_m.html#gga661221ba5e8f1d6eaf4ab8e2da57cc1aa7de225785e05dd1d538203c5ece9036e">SND_PCM_ACCESS_MMAP_NONINTERLEAVED</a>, direct_loop },
        { <span class="stringliteral">&quot;direct_write&quot;</span>, <a class="code" href="group___p_c_m.html#gga661221ba5e8f1d6eaf4ab8e2da57cc1aa90a5dea527c5ae9a53f1448beb2dee6f">SND_PCM_ACCESS_MMAP_INTERLEAVED</a>, direct_write_loop },
        { NULL, <a class="code" href="group___p_c_m.html#gga661221ba5e8f1d6eaf4ab8e2da57cc1aa72a970ed6e676ab0fd9f3c3d36737e0a">SND_PCM_ACCESS_RW_INTERLEAVED</a>, NULL }
};

<span class="keyword">static</span> <span class="keywordtype">void</span> help(<span class="keywordtype">void</span>)
{
        <span class="keywordtype">int</span> k;
        printf(
<span class="stringliteral">&quot;Usage: pcm [OPTION]... [FILE]...\n&quot;</span>
<span class="stringliteral">&quot;-h,--help      help\n&quot;</span>
<span class="stringliteral">&quot;-D,--device    playback device\n&quot;</span>
<span class="stringliteral">&quot;-r,--rate      stream rate in Hz\n&quot;</span>
<span class="stringliteral">&quot;-c,--channels  count of channels in stream\n&quot;</span>
<span class="stringliteral">&quot;-f,--frequency sine wave frequency in Hz\n&quot;</span>
<span class="stringliteral">&quot;-b,--buffer    ring buffer size in us\n&quot;</span>
<span class="stringliteral">&quot;-p,--period    period size in us\n&quot;</span>
<span class="stringliteral">&quot;-m,--method    transfer method\n&quot;</span>
<span class="stringliteral">&quot;-o,--format    sample format\n&quot;</span>
<span class="stringliteral">&quot;-v,--verbose   show the PCM setup parameters\n&quot;</span>
<span class="stringliteral">&quot;-n,--noresample  do not resample\n&quot;</span>
<span class="stringliteral">&quot;-e,--pevent    enable poll event after each period\n&quot;</span>
<span class="stringliteral">&quot;\n&quot;</span>);
        printf(<span class="stringliteral">&quot;Recognized sample formats are:&quot;</span>);
        <span class="keywordflow">for</span> (k = 0; k &lt; SND_PCM_FORMAT_LAST; ++k) {
                <span class="keyword">const</span> <span class="keywordtype">char</span> *s = <a name="a57"></a><a class="code" href="group___p_c_m___description.html#ga2ca258b8ac569ca35f283e48d2181e45" title="get name of PCM sample format">snd_pcm_format_name</a>(k);
                <span class="keywordflow">if</span> (s)
                        printf(<span class="stringliteral">&quot; %s&quot;</span>, s);
        }
        printf(<span class="stringliteral">&quot;\n&quot;</span>);
        printf(<span class="stringliteral">&quot;Recognized transfer methods are:&quot;</span>);
        <span class="keywordflow">for</span> (k = 0; transfer_methods[k].name; k++)
                printf(<span class="stringliteral">&quot; %s&quot;</span>, transfer_methods[k].name);
        printf(<span class="stringliteral">&quot;\n&quot;</span>);
}

<span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
{
        <span class="keyword">struct </span>option long_option[] =
        {
                {<span class="stringliteral">&quot;help&quot;</span>, 0, NULL, <span class="charliteral">&apos;h&apos;</span>},
                {<span class="stringliteral">&quot;device&quot;</span>, 1, NULL, <span class="charliteral">&apos;D&apos;</span>},
                {<span class="stringliteral">&quot;rate&quot;</span>, 1, NULL, <span class="charliteral">&apos;r&apos;</span>},
                {<span class="stringliteral">&quot;channels&quot;</span>, 1, NULL, <span class="charliteral">&apos;c&apos;</span>},
                {<span class="stringliteral">&quot;frequency&quot;</span>, 1, NULL, <span class="charliteral">&apos;f&apos;</span>},
                {<span class="stringliteral">&quot;buffer&quot;</span>, 1, NULL, <span class="charliteral">&apos;b&apos;</span>},
                {<span class="stringliteral">&quot;period&quot;</span>, 1, NULL, <span class="charliteral">&apos;p&apos;</span>},
                {<span class="stringliteral">&quot;method&quot;</span>, 1, NULL, <span class="charliteral">&apos;m&apos;</span>},
                {<span class="stringliteral">&quot;format&quot;</span>, 1, NULL, <span class="charliteral">&apos;o&apos;</span>},
                {<span class="stringliteral">&quot;verbose&quot;</span>, 1, NULL, <span class="charliteral">&apos;v&apos;</span>},
                {<span class="stringliteral">&quot;noresample&quot;</span>, 1, NULL, <span class="charliteral">&apos;n&apos;</span>},
                {<span class="stringliteral">&quot;pevent&quot;</span>, 1, NULL, <span class="charliteral">&apos;e&apos;</span>},
                {NULL, 0, NULL, 0},
        };
        <a class="code" href="group___p_c_m.html#ga919e634deecd855b6e2e15174e70d3ea">snd_pcm_t</a> *handle;
        <span class="keywordtype">int</span> err, morehelp;
        <a class="code" href="group___p_c_m.html#ga65c737127994f0a980edad744e36dc40">snd_pcm_hw_params_t</a> *hwparams;
        <a class="code" href="group___p_c_m.html#ga7e082d9ea701709270b0674a0be23b09">snd_pcm_sw_params_t</a> *swparams;
        <span class="keywordtype">int</span> method = 0;
        <span class="keywordtype">signed</span> <span class="keywordtype">short</span> *samples;
        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> chn;
        <a class="code" href="structsnd__pcm__channel__area__t.html">snd_pcm_channel_area_t</a> *areas;

        <a name="a58"></a><a class="code" href="group___p_c_m___h_w___params.html#ga06b83cb9a788f99b7b09b570b4355cee" title="allocate an invalid snd_pcm_hw_params_t using standard alloca">snd_pcm_hw_params_alloca</a>(&amp;hwparams);
        <a name="a59"></a><a class="code" href="group___p_c_m___s_w___params.html#ga8e564553bdc89948c918729e3cc7beb0" title="allocate an invalid snd_pcm_sw_params_t using standard alloca">snd_pcm_sw_params_alloca</a>(&amp;swparams);

        morehelp = 0;
        <span class="keywordflow">while</span> (1) {
                <span class="keywordtype">int</span> c;
                <span class="keywordflow">if</span> ((c = getopt_long(argc, argv, <span class="stringliteral">&quot;hD:r:c:f:b:p:m:o:vne&quot;</span>, long_option, NULL)) &lt; 0)
                        <span class="keywordflow">break</span>;
                <span class="keywordflow">switch</span> (c) {
                <span class="keywordflow">case</span> <span class="charliteral">&apos;h&apos;</span>:
                        morehelp++;
                        <span class="keywordflow">break</span>;
                <span class="keywordflow">case</span> <span class="charliteral">&apos;D&apos;</span>:
                        device = strdup(optarg);
                        <span class="keywordflow">break</span>;
                <span class="keywordflow">case</span> <span class="charliteral">&apos;r&apos;</span>:
                        rate = atoi(optarg);
                        rate = rate &lt; 4000 ? 4000 : rate;
                        rate = rate &gt; 196000 ? 196000 : rate;
                        <span class="keywordflow">break</span>;
                <span class="keywordflow">case</span> <span class="charliteral">&apos;c&apos;</span>:
                        channels = atoi(optarg);
                        channels = channels &lt; 1 ? 1 : channels;
                        channels = channels &gt; 1024 ? 1024 : channels;
                        <span class="keywordflow">break</span>;
                <span class="keywordflow">case</span> <span class="charliteral">&apos;f&apos;</span>:
                        freq = atoi(optarg);
                        freq = freq &lt; 50 ? 50 : freq;
                        freq = freq &gt; 5000 ? 5000 : freq;
                        <span class="keywordflow">break</span>;
                <span class="keywordflow">case</span> <span class="charliteral">&apos;b&apos;</span>:
                        buffer_time = atoi(optarg);
                        buffer_time = buffer_time &lt; 1000 ? 1000 : buffer_time;
                        buffer_time = buffer_time &gt; 1000000 ? 1000000 : buffer_time;
                        <span class="keywordflow">break</span>;
                <span class="keywordflow">case</span> <span class="charliteral">&apos;p&apos;</span>:
                        period_time = atoi(optarg);
                        period_time = period_time &lt; 1000 ? 1000 : period_time;
                        period_time = period_time &gt; 1000000 ? 1000000 : period_time;
                        <span class="keywordflow">break</span>;
                <span class="keywordflow">case</span> <span class="charliteral">&apos;m&apos;</span>:
                        <span class="keywordflow">for</span> (method = 0; transfer_methods[method].name; method++)
                                        <span class="keywordflow">if</span> (!strcasecmp(transfer_methods[method].name, optarg))
                                        <span class="keywordflow">break</span>;
                        <span class="keywordflow">if</span> (transfer_methods[method].name == NULL)
                                method = 0;
                        <span class="keywordflow">break</span>;
                <span class="keywordflow">case</span> <span class="charliteral">&apos;o&apos;</span>:
                        <span class="keywordflow">for</span> (format = 0; format &lt; SND_PCM_FORMAT_LAST; format++) {
                                <span class="keyword">const</span> <span class="keywordtype">char</span> *format_name = <a class="code" href="group___p_c_m___description.html#ga2ca258b8ac569ca35f283e48d2181e45" title="get name of PCM sample format">snd_pcm_format_name</a>(format);
                                <span class="keywordflow">if</span> (format_name)
                                        <span class="keywordflow">if</span> (!strcasecmp(format_name, optarg))
                                        <span class="keywordflow">break</span>;
                        }
                        <span class="keywordflow">if</span> (format == SND_PCM_FORMAT_LAST)
                                format = <a class="code" href="group___p_c_m.html#ggaa14b7f26877a812acbb39811364177f8aac4470b6be81c22af0cfe528bee4a474">SND_PCM_FORMAT_S16</a>;
                        <span class="keywordflow">if</span> (!<a name="a60"></a><a class="code" href="group___p_c_m___helpers.html#ga5a52bb63323f463198dea3f3c6aca571" title="Return linear info for a PCM sample format.">snd_pcm_format_linear</a>(format) &amp;&amp;
                            !(format == <a class="code" href="group___p_c_m.html#ggaa14b7f26877a812acbb39811364177f8a083f32474a84d344e0da496470085c8f">SND_PCM_FORMAT_FLOAT_LE</a> ||
                              format == <a class="code" href="group___p_c_m.html#ggaa14b7f26877a812acbb39811364177f8ab24eac408b0d2ae6b5f68ed3a7cd2d75">SND_PCM_FORMAT_FLOAT_BE</a>)) {
                                printf(<span class="stringliteral">&quot;Invalid (non-linear/float) format %s\n&quot;</span>,
                                       optarg);
                                <span class="keywordflow">return</span> 1;
                        }
                        <span class="keywordflow">break</span>;
                <span class="keywordflow">case</span> <span class="charliteral">&apos;v&apos;</span>:
                        verbose = 1;
                        <span class="keywordflow">break</span>;
                <span class="keywordflow">case</span> <span class="charliteral">&apos;n&apos;</span>:
                        resample = 0;
                        <span class="keywordflow">break</span>;
                <span class="keywordflow">case</span> <span class="charliteral">&apos;e&apos;</span>:
                        period_event = 1;
                        <span class="keywordflow">break</span>;
                }
        }

        <span class="keywordflow">if</span> (morehelp) {
                help();
                <span class="keywordflow">return</span> 0;
        }

        err = <a name="a61"></a><a class="code" href="group___output.html#gaca78d01bf6d081274650794861373c7d" title="Creates a new output object using an existing stdio FILE pointer.">snd_output_stdio_attach</a>(&amp;output, stdout, 0);
        <span class="keywordflow">if</span> (err &lt; 0) {
                printf(<span class="stringliteral">&quot;Output failed: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                <span class="keywordflow">return</span> 0;
        }

        printf(<span class="stringliteral">&quot;Playback device is %s\n&quot;</span>, device);
        printf(<span class="stringliteral">&quot;Stream parameters are %iHz, %s, %i channels\n&quot;</span>, rate, <a class="code" href="group___p_c_m___description.html#ga2ca258b8ac569ca35f283e48d2181e45" title="get name of PCM sample format">snd_pcm_format_name</a>(format), channels);
        printf(<span class="stringliteral">&quot;Sine wave rate is %.4fHz\n&quot;</span>, freq);
        printf(<span class="stringliteral">&quot;Using transfer method: %s\n&quot;</span>, transfer_methods[method].name);

        <span class="keywordflow">if</span> ((err = <a name="a62"></a><a class="code" href="group___p_c_m.html#ga8340c7dc0ac37f37afe5e7c21d6c528b" title="Opens a PCM.">snd_pcm_open</a>(&amp;handle, device, <a name="a63"></a><a class="code" href="group___p_c_m.html#ggac23b43ff55add78638e503b9cc892c24a57a2b920dbc34173479fc9036cfc78a1">SND_PCM_STREAM_PLAYBACK</a>, 0)) &lt; 0) {
                printf(<span class="stringliteral">&quot;Playback open error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                <span class="keywordflow">return</span> 0;
        }
        
        <span class="keywordflow">if</span> ((err = set_hwparams(handle, hwparams, transfer_methods[method].access)) &lt; 0) {
                printf(<span class="stringliteral">&quot;Setting of hwparams failed: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                exit(EXIT_FAILURE);
        }
        <span class="keywordflow">if</span> ((err = set_swparams(handle, swparams)) &lt; 0) {
                printf(<span class="stringliteral">&quot;Setting of swparams failed: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                exit(EXIT_FAILURE);
        }

        <span class="keywordflow">if</span> (verbose &gt; 0)
                <a name="a64"></a><a class="code" href="group___p_c_m___dump.html#ga9c5c879409c504e155e234905d031d8d" title="Dump PCM info.">snd_pcm_dump</a>(handle, output);

        samples = malloc((period_size * channels * <a class="code" href="group___p_c_m___helpers.html#gaa3e0ff7560342e5af2b5c7bd2d63a307" title="Return bits needed to store a PCM sample.">snd_pcm_format_physical_width</a>(format)) / 8);
        <span class="keywordflow">if</span> (samples == NULL) {
                printf(<span class="stringliteral">&quot;No enough memory\n&quot;</span>);
                exit(EXIT_FAILURE);
        }
        
        areas = calloc(channels, <span class="keyword">sizeof</span>(<a class="code" href="structsnd__pcm__channel__area__t.html">snd_pcm_channel_area_t</a>));
        <span class="keywordflow">if</span> (areas == NULL) {
                printf(<span class="stringliteral">&quot;No enough memory\n&quot;</span>);
                exit(EXIT_FAILURE);
        }
        <span class="keywordflow">for</span> (chn = 0; chn &lt; channels; chn++) {
                areas[chn].<a name="a65"></a><a class="code" href="structsnd__pcm__channel__area__t.html#a83acdf3245dcb74dffe74cce53d65876">addr</a> = samples;
                areas[chn].<a class="code" href="structsnd__pcm__channel__area__t.html#aba2a69e0d221beaa9f2f115254cb515a">first</a> = chn * <a class="code" href="group___p_c_m___helpers.html#gaa3e0ff7560342e5af2b5c7bd2d63a307" title="Return bits needed to store a PCM sample.">snd_pcm_format_physical_width</a>(format);
                areas[chn].<a class="code" href="structsnd__pcm__channel__area__t.html#aedbe57a917a0ba24bf1f526387e6e43a">step</a> = channels * <a class="code" href="group___p_c_m___helpers.html#gaa3e0ff7560342e5af2b5c7bd2d63a307" title="Return bits needed to store a PCM sample.">snd_pcm_format_physical_width</a>(format);
        }

        err = transfer_methods[method].transfer_loop(handle, samples, areas);
        <span class="keywordflow">if</span> (err &lt; 0)
                printf(<span class="stringliteral">&quot;Transfer failed: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));

        free(areas);
        free(samples);
        <a name="a66"></a><a class="code" href="group___p_c_m.html#ga042aba7262a4cbb4d444b6fc08cb7124" title="close PCM handle">snd_pcm_close</a>(handle);
        <span class="keywordflow">return</span> 0;
}

</pre></div> </div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr size="1"><address style="text-align: right;"><small>
Generated for ALSA project - the C library reference by&nbsp;<a href="http://www.doxygen.org/
index.html"><img src="doxygen.png" alt="doxygen" align="middle" border="0"></a>
1.6.1</small></address>
</body>
</html>
