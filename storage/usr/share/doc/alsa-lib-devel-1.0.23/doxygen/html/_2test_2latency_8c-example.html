<!-- This comment will put IE 6, 7 and 8 in quirks mode -->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>ALSA project - the C library reference: /test/latency.c</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <img id="MSearchSelect" src="search/search.png"
             onmouseover="return searchBox.OnSearchSelectShow()"
             onmouseout="return searchBox.OnSearchSelectHide()"
             alt=""/>
        <input type="text" id="MSearchField" value="Search" accesskey="S"
             onfocus="searchBox.OnSearchFieldFocus(true)" 
             onblur="searchBox.OnSearchFieldFocus(false)" 
             onkeyup="searchBox.OnSearchFieldChange(event)"/>
        <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
        </div>
      </li>
    </ul>
  </div>
</div>
<div class="contents">
<h1>/test/latency.c</h1><div class="fragment"><pre class="fragment"><span class="comment">/*</span>
<span class="comment"> *  Latency test program</span>
<span class="comment"> *</span>
<span class="comment"> *     Author: Jaroslav Kysela &lt;perex@perex.cz&gt;</span>
<span class="comment"> *</span>
<span class="comment"> *     Author of bandpass filter sweep effect:</span>
<span class="comment"> *             Maarten de Boer &lt;mdeboer@iua.upf.es&gt;</span>
<span class="comment"> *</span>
<span class="comment"> *  This small demo program can be used for measuring latency between</span>
<span class="comment"> *  capture and playback. This latency is measured from driver (diff when</span>
<span class="comment"> *  playback and capture was started). Scheduler is set to SCHED_RR.</span>
<span class="comment"> *</span>
<span class="comment"> *</span>
<span class="comment"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="comment"> *   it under the terms of the GNU General Public License as published by</span>
<span class="comment"> *   the Free Software Foundation; either version 2 of the License, or</span>
<span class="comment"> *   (at your option) any later version.</span>
<span class="comment"> *</span>
<span class="comment"> *   This program is distributed in the hope that it will be useful,</span>
<span class="comment"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="comment"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="comment"> *   GNU General Public License for more details.</span>
<span class="comment"> *</span>
<span class="comment"> *   You should have received a copy of the GNU General Public License</span>
<span class="comment"> *   along with this program; if not, write to the Free Software</span>
<span class="comment"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="comment"> *</span>
<span class="comment"> */</span>

<span class="preprocessor">#include &lt;stdio.h&gt;</span>
<span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<span class="preprocessor">#include &lt;string.h&gt;</span>
<span class="preprocessor">#include &lt;sched.h&gt;</span>
<span class="preprocessor">#include &lt;errno.h&gt;</span>
<span class="preprocessor">#include &lt;getopt.h&gt;</span>
<span class="preprocessor">#include &quot;../include/asoundlib.h&quot;</span>
<span class="preprocessor">#include &lt;sys/time.h&gt;</span>
<span class="preprocessor">#include &lt;math.h&gt;</span>

<span class="keywordtype">char</span> *pdevice = <span class="stringliteral">&quot;hw:0,0&quot;</span>;
<span class="keywordtype">char</span> *cdevice = <span class="stringliteral">&quot;hw:0,0&quot;</span>;
<a class="code" href="group___p_c_m.html#gaa14b7f26877a812acbb39811364177f8">snd_pcm_format_t</a> format = <a name="a0"></a><a class="code" href="group___p_c_m.html#ggaa14b7f26877a812acbb39811364177f8a8b66a29293c62df9d1678c609fab76c0">SND_PCM_FORMAT_S16_LE</a>;
<span class="keywordtype">int</span> rate = 22050;
<span class="keywordtype">int</span> channels = 2;
<span class="keywordtype">int</span> buffer_size = 0;            <span class="comment">/* auto */</span>
<span class="keywordtype">int</span> period_size = 0;            <span class="comment">/* auto */</span>
<span class="keywordtype">int</span> latency_min = 32;           <span class="comment">/* in frames / 2 */</span>
<span class="keywordtype">int</span> latency_max = 2048;         <span class="comment">/* in frames / 2 */</span>
<span class="keywordtype">int</span> loop_sec = 30;              <span class="comment">/* seconds */</span>
<span class="keywordtype">int</span> block = 0;                  <span class="comment">/* block mode */</span>
<span class="keywordtype">int</span> use_poll = 0;
<span class="keywordtype">int</span> resample = 1;
<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> loop_limit;

<a name="a1"></a><a class="code" href="group___output.html#ga49729cc6454539495c1f5b6e95cd474a" title="Internal structure for an output object.">snd_output_t</a> *output = NULL;

<span class="keywordtype">int</span> setparams_stream(<a name="a2"></a><a class="code" href="group___p_c_m.html#ga919e634deecd855b6e2e15174e70d3ea">snd_pcm_t</a> *handle,
                     <a name="a3"></a><a class="code" href="group___p_c_m.html#ga65c737127994f0a980edad744e36dc40">snd_pcm_hw_params_t</a> *params,
                     <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span>)
{
        <span class="keywordtype">int</span> err;
        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> rrate;

        err = <a name="a4"></a><a class="code" href="group___p_c_m___h_w___params.html#ga6e2dd8efbb7a4084bd05e6cc458d84f7" title="Fill params with a full configuration space for a PCM.">snd_pcm_hw_params_any</a>(handle, params);
        <span class="keywordflow">if</span> (err &lt; 0) {
                printf(<span class="stringliteral">&quot;Broken configuration for %s PCM: no configurations available: %s\n&quot;</span>, <a name="a5"></a><a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err), <span class="keywordtype">id</span>);
                <span class="keywordflow">return</span> err;
        }
        err = <a name="a6"></a><a class="code" href="group___p_c_m___h_w___params.html#ga82eecc0e27a94ce0caa195cc3765536c" title="Restrict a configuration space to contain only real hardware rates.">snd_pcm_hw_params_set_rate_resample</a>(handle, params, resample);
        <span class="keywordflow">if</span> (err &lt; 0) {
                printf(<span class="stringliteral">&quot;Resample setup failed for %s (val %i): %s\n&quot;</span>, <span class="keywordtype">id</span>, resample, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                <span class="keywordflow">return</span> err;
        }
        err = <a name="a7"></a><a class="code" href="group___p_c_m___h_w___params.html#ga4c8f1c632931923531ca68ee048a8de8" title="Restrict a configuration space to contain only one access type.">snd_pcm_hw_params_set_access</a>(handle, params, <a name="a8"></a><a class="code" href="group___p_c_m.html#gga661221ba5e8f1d6eaf4ab8e2da57cc1aa72a970ed6e676ab0fd9f3c3d36737e0a">SND_PCM_ACCESS_RW_INTERLEAVED</a>);
        <span class="keywordflow">if</span> (err &lt; 0) {
                printf(<span class="stringliteral">&quot;Access type not available for %s: %s\n&quot;</span>, <span class="keywordtype">id</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                <span class="keywordflow">return</span> err;
        }
        err = <a name="a9"></a><a class="code" href="group___p_c_m___h_w___params.html#ga6014e0e1ec7934f8c745290e83e59199" title="Restrict a configuration space to contain only one format.">snd_pcm_hw_params_set_format</a>(handle, params, format);
        <span class="keywordflow">if</span> (err &lt; 0) {
                printf(<span class="stringliteral">&quot;Sample format not available for %s: %s\n&quot;</span>, <span class="keywordtype">id</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                <span class="keywordflow">return</span> err;
        }
        err = <a name="a10"></a><a class="code" href="group___p_c_m___h_w___params.html#ga3a5b2a05c5d9869cc743dac71c0d270a" title="Restrict a configuration space to contain only one channels count.">snd_pcm_hw_params_set_channels</a>(handle, params, channels);
        <span class="keywordflow">if</span> (err &lt; 0) {
                printf(<span class="stringliteral">&quot;Channels count (%i) not available for %s: %s\n&quot;</span>, channels, <span class="keywordtype">id</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                <span class="keywordflow">return</span> err;
        }
        rrate = rate;
        err = <a name="a11"></a><a class="code" href="group___p_c_m___h_w___params.html#ga39124280d06ce63092a77e3f25ddd6ee" title="Restrict a configuration space to have rate nearest to a target.">snd_pcm_hw_params_set_rate_near</a>(handle, params, &amp;rrate, 0);
        <span class="keywordflow">if</span> (err &lt; 0) {
                printf(<span class="stringliteral">&quot;Rate %iHz not available for %s: %s\n&quot;</span>, rate, <span class="keywordtype">id</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                <span class="keywordflow">return</span> err;
        }
        <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)rrate != rate) {
                printf(<span class="stringliteral">&quot;Rate doesn&apos;t match (requested %iHz, get %iHz)\n&quot;</span>, rate, err);
                <span class="keywordflow">return</span> -EINVAL;
        }
        <span class="keywordflow">return</span> 0;
}

<span class="keywordtype">int</span> setparams_bufsize(<a class="code" href="group___p_c_m.html#ga919e634deecd855b6e2e15174e70d3ea">snd_pcm_t</a> *handle,
                      <a class="code" href="group___p_c_m.html#ga65c737127994f0a980edad744e36dc40">snd_pcm_hw_params_t</a> *params,
                      <a class="code" href="group___p_c_m.html#ga65c737127994f0a980edad744e36dc40">snd_pcm_hw_params_t</a> *tparams,
                      <a name="a12"></a><a class="code" href="group___p_c_m.html#gab01fcfe9b97382a8d3f2027c664b8b8a">snd_pcm_uframes_t</a> bufsize,
                      <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span>)
{
        <span class="keywordtype">int</span> err;
        <a class="code" href="group___p_c_m.html#gab01fcfe9b97382a8d3f2027c664b8b8a">snd_pcm_uframes_t</a> periodsize;

        <a name="a13"></a><a class="code" href="group___p_c_m___h_w___params.html#ga9bcedf4bb4b21527a584846a5986a1f4" title="copy one snd_pcm_hw_params_t to another">snd_pcm_hw_params_copy</a>(params, tparams);
        periodsize = bufsize * 2;
        err = <a name="a14"></a><a class="code" href="group___p_c_m___h_w___params.html#ga2c00cb635d374030595dbc27b7a983a7" title="Restrict a configuration space to have buffer size nearest to a target.">snd_pcm_hw_params_set_buffer_size_near</a>(handle, params, &amp;periodsize);
        <span class="keywordflow">if</span> (err &lt; 0) {
                printf(<span class="stringliteral">&quot;Unable to set buffer size %li for %s: %s\n&quot;</span>, bufsize * 2, <span class="keywordtype">id</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                <span class="keywordflow">return</span> err;
        }
        <span class="keywordflow">if</span> (period_size &gt; 0)
                periodsize = period_size;
        <span class="keywordflow">else</span>
                periodsize /= 2;
        err = <a name="a15"></a><a class="code" href="group___p_c_m___h_w___params.html#ga9162045265f283c532634506456cab09" title="Restrict a configuration space to have period size nearest to a target.">snd_pcm_hw_params_set_period_size_near</a>(handle, params, &amp;periodsize, 0);
        <span class="keywordflow">if</span> (err &lt; 0) {
                printf(<span class="stringliteral">&quot;Unable to set period size %li for %s: %s\n&quot;</span>, periodsize, <span class="keywordtype">id</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                <span class="keywordflow">return</span> err;
        }
        <span class="keywordflow">return</span> 0;
}

<span class="keywordtype">int</span> setparams_set(<a class="code" href="group___p_c_m.html#ga919e634deecd855b6e2e15174e70d3ea">snd_pcm_t</a> *handle,
                  <a class="code" href="group___p_c_m.html#ga65c737127994f0a980edad744e36dc40">snd_pcm_hw_params_t</a> *params,
                  <a name="a16"></a><a class="code" href="group___p_c_m.html#ga7e082d9ea701709270b0674a0be23b09">snd_pcm_sw_params_t</a> *swparams,
                  <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span>)
{
        <span class="keywordtype">int</span> err;
        <a class="code" href="group___p_c_m.html#gab01fcfe9b97382a8d3f2027c664b8b8a">snd_pcm_uframes_t</a> val;

        err = <a name="a17"></a><a class="code" href="group___p_c_m.html#ga1ca0dc120a484965e26cabf966502330" title="Install one PCM hardware configuration chosen from a configuration space and snd_pcm_prepare...">snd_pcm_hw_params</a>(handle, params);
        <span class="keywordflow">if</span> (err &lt; 0) {
                printf(<span class="stringliteral">&quot;Unable to set hw params for %s: %s\n&quot;</span>, <span class="keywordtype">id</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                <span class="keywordflow">return</span> err;
        }
        err = <a name="a18"></a><a class="code" href="group___p_c_m.html#ga61c5495ffb44c75aaa595e85512d28de" title="Return current software configuration for a PCM.">snd_pcm_sw_params_current</a>(handle, swparams);
        <span class="keywordflow">if</span> (err &lt; 0) {
                printf(<span class="stringliteral">&quot;Unable to determine current swparams for %s: %s\n&quot;</span>, <span class="keywordtype">id</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                <span class="keywordflow">return</span> err;
        }
        err = <a name="a19"></a><a class="code" href="group___p_c_m___s_w___params.html#ga1d338f1f7e33b7a6d0f9a8f61f87f057" title="Set start threshold inside a software configuration container.">snd_pcm_sw_params_set_start_threshold</a>(handle, swparams, 0x7fffffff);
        <span class="keywordflow">if</span> (err &lt; 0) {
                printf(<span class="stringliteral">&quot;Unable to set start threshold mode for %s: %s\n&quot;</span>, <span class="keywordtype">id</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                <span class="keywordflow">return</span> err;
        }
        <span class="keywordflow">if</span> (!block)
                val = 4;
        <span class="keywordflow">else</span>
                <a name="a20"></a><a class="code" href="group___p_c_m___h_w___params.html#gaba48ea189171536f9793e0d99e6db5e0" title="Extract period size from a configuration space.">snd_pcm_hw_params_get_period_size</a>(params, &amp;val, NULL);
        err = <a name="a21"></a><a class="code" href="group___p_c_m___s_w___params.html#ga79b12cbbd309750156261e7f5a39167b" title="Set avail min inside a software configuration container.">snd_pcm_sw_params_set_avail_min</a>(handle, swparams, val);
        <span class="keywordflow">if</span> (err &lt; 0) {
                printf(<span class="stringliteral">&quot;Unable to set avail min for %s: %s\n&quot;</span>, <span class="keywordtype">id</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                <span class="keywordflow">return</span> err;
        }
        err = <a name="a22"></a><a class="code" href="group___p_c_m.html#ga891ccaeea2c685a533b61b5fa0493974" title="Install PCM software configuration defined by params.">snd_pcm_sw_params</a>(handle, swparams);
        <span class="keywordflow">if</span> (err &lt; 0) {
                printf(<span class="stringliteral">&quot;Unable to set sw params for %s: %s\n&quot;</span>, <span class="keywordtype">id</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                <span class="keywordflow">return</span> err;
        }
        <span class="keywordflow">return</span> 0;
}

<span class="keywordtype">int</span> setparams(<a class="code" href="group___p_c_m.html#ga919e634deecd855b6e2e15174e70d3ea">snd_pcm_t</a> *phandle, <a class="code" href="group___p_c_m.html#ga919e634deecd855b6e2e15174e70d3ea">snd_pcm_t</a> *chandle, <span class="keywordtype">int</span> *bufsize)
{
        <span class="keywordtype">int</span> err, last_bufsize = *bufsize;
        <a class="code" href="group___p_c_m.html#ga65c737127994f0a980edad744e36dc40">snd_pcm_hw_params_t</a> *pt_params, *ct_params;     <span class="comment">/* templates with rate, format and channels */</span>
        <a class="code" href="group___p_c_m.html#ga65c737127994f0a980edad744e36dc40">snd_pcm_hw_params_t</a> *p_params, *c_params;
        <a class="code" href="group___p_c_m.html#ga7e082d9ea701709270b0674a0be23b09">snd_pcm_sw_params_t</a> *p_swparams, *c_swparams;
        <a class="code" href="group___p_c_m.html#gab01fcfe9b97382a8d3f2027c664b8b8a">snd_pcm_uframes_t</a> p_size, c_size, p_psize, c_psize;
        <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> p_time, c_time;

        <a name="a23"></a><a class="code" href="group___p_c_m___h_w___params.html#ga06b83cb9a788f99b7b09b570b4355cee" title="allocate an invalid snd_pcm_hw_params_t using standard alloca">snd_pcm_hw_params_alloca</a>(&amp;p_params);
        <a class="code" href="group___p_c_m___h_w___params.html#ga06b83cb9a788f99b7b09b570b4355cee" title="allocate an invalid snd_pcm_hw_params_t using standard alloca">snd_pcm_hw_params_alloca</a>(&amp;c_params);
        <a class="code" href="group___p_c_m___h_w___params.html#ga06b83cb9a788f99b7b09b570b4355cee" title="allocate an invalid snd_pcm_hw_params_t using standard alloca">snd_pcm_hw_params_alloca</a>(&amp;pt_params);
        <a class="code" href="group___p_c_m___h_w___params.html#ga06b83cb9a788f99b7b09b570b4355cee" title="allocate an invalid snd_pcm_hw_params_t using standard alloca">snd_pcm_hw_params_alloca</a>(&amp;ct_params);
        <a name="a24"></a><a class="code" href="group___p_c_m___s_w___params.html#ga8e564553bdc89948c918729e3cc7beb0" title="allocate an invalid snd_pcm_sw_params_t using standard alloca">snd_pcm_sw_params_alloca</a>(&amp;p_swparams);
        <a class="code" href="group___p_c_m___s_w___params.html#ga8e564553bdc89948c918729e3cc7beb0" title="allocate an invalid snd_pcm_sw_params_t using standard alloca">snd_pcm_sw_params_alloca</a>(&amp;c_swparams);
        <span class="keywordflow">if</span> ((err = setparams_stream(phandle, pt_params, <span class="stringliteral">&quot;playback&quot;</span>)) &lt; 0) {
                printf(<span class="stringliteral">&quot;Unable to set parameters for playback stream: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                exit(0);
        }
        <span class="keywordflow">if</span> ((err = setparams_stream(chandle, ct_params, <span class="stringliteral">&quot;capture&quot;</span>)) &lt; 0) {
                printf(<span class="stringliteral">&quot;Unable to set parameters for playback stream: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                exit(0);
        }

        <span class="keywordflow">if</span> (buffer_size &gt; 0) {
                *bufsize = buffer_size;
                <span class="keywordflow">goto</span> __set_it;
        }

      __again:
        <span class="keywordflow">if</span> (buffer_size &gt; 0)
                <span class="keywordflow">return</span> -1;
        <span class="keywordflow">if</span> (last_bufsize == *bufsize)
                *bufsize += 4;
        last_bufsize = *bufsize;
        <span class="keywordflow">if</span> (*bufsize &gt; latency_max)
                <span class="keywordflow">return</span> -1;
      __set_it:
        <span class="keywordflow">if</span> ((err = setparams_bufsize(phandle, p_params, pt_params, *bufsize, <span class="stringliteral">&quot;playback&quot;</span>)) &lt; 0) {
                printf(<span class="stringliteral">&quot;Unable to set sw parameters for playback stream: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                exit(0);
        }
        <span class="keywordflow">if</span> ((err = setparams_bufsize(chandle, c_params, ct_params, *bufsize, <span class="stringliteral">&quot;capture&quot;</span>)) &lt; 0) {
                printf(<span class="stringliteral">&quot;Unable to set sw parameters for playback stream: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                exit(0);
        }

        <a class="code" href="group___p_c_m___h_w___params.html#gaba48ea189171536f9793e0d99e6db5e0" title="Extract period size from a configuration space.">snd_pcm_hw_params_get_period_size</a>(p_params, &amp;p_psize, NULL);
        <span class="keywordflow">if</span> (p_psize &gt; (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)*bufsize)
                *bufsize = p_psize;
        <a class="code" href="group___p_c_m___h_w___params.html#gaba48ea189171536f9793e0d99e6db5e0" title="Extract period size from a configuration space.">snd_pcm_hw_params_get_period_size</a>(c_params, &amp;c_psize, NULL);
        <span class="keywordflow">if</span> (c_psize &gt; (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)*bufsize)
                *bufsize = c_psize;
        <a name="a25"></a><a class="code" href="group___p_c_m___h_w___params.html#ga71f5d43bf63dc7292b8b58f17acccf89" title="Extract period time from a configuration space.">snd_pcm_hw_params_get_period_time</a>(p_params, &amp;p_time, NULL);
        <a class="code" href="group___p_c_m___h_w___params.html#ga71f5d43bf63dc7292b8b58f17acccf89" title="Extract period time from a configuration space.">snd_pcm_hw_params_get_period_time</a>(c_params, &amp;c_time, NULL);
        <span class="keywordflow">if</span> (p_time != c_time)
                <span class="keywordflow">goto</span> __again;

        <a name="a26"></a><a class="code" href="group___p_c_m___h_w___params.html#gab6556fcaaf926360d2064044a6f6cfb4" title="Extract buffer size from a configuration space.">snd_pcm_hw_params_get_buffer_size</a>(p_params, &amp;p_size);
        <span class="keywordflow">if</span> (p_psize * 2 &lt; p_size)
                <span class="keywordflow">goto</span> __again;
        <a class="code" href="group___p_c_m___h_w___params.html#gab6556fcaaf926360d2064044a6f6cfb4" title="Extract buffer size from a configuration space.">snd_pcm_hw_params_get_buffer_size</a>(c_params, &amp;c_size);
        <span class="keywordflow">if</span> (c_psize * 2 &lt; c_size)
                <span class="keywordflow">goto</span> __again;

        <span class="keywordflow">if</span> ((err = setparams_set(phandle, p_params, p_swparams, <span class="stringliteral">&quot;playback&quot;</span>)) &lt; 0) {
                printf(<span class="stringliteral">&quot;Unable to set sw parameters for playback stream: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                exit(0);
        }
        <span class="keywordflow">if</span> ((err = setparams_set(chandle, c_params, c_swparams, <span class="stringliteral">&quot;capture&quot;</span>)) &lt; 0) {
                printf(<span class="stringliteral">&quot;Unable to set sw parameters for playback stream: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                exit(0);
        }

        <span class="keywordflow">if</span> ((err = <a name="a27"></a><a class="code" href="group___p_c_m.html#ga788d05de75f2d536f8443cb0306754d0" title="Prepare PCM for use.">snd_pcm_prepare</a>(phandle)) &lt; 0) {
                printf(<span class="stringliteral">&quot;Prepare error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                exit(0);
        }

        <a name="a28"></a><a class="code" href="group___p_c_m___dump.html#ga9c5c879409c504e155e234905d031d8d" title="Dump PCM info.">snd_pcm_dump</a>(phandle, output);
        <a class="code" href="group___p_c_m___dump.html#ga9c5c879409c504e155e234905d031d8d" title="Dump PCM info.">snd_pcm_dump</a>(chandle, output);
        fflush(stdout);
        <span class="keywordflow">return</span> 0;
}

<span class="keywordtype">void</span> showstat(<a class="code" href="group___p_c_m.html#ga919e634deecd855b6e2e15174e70d3ea">snd_pcm_t</a> *handle, <span class="keywordtype">size_t</span> frames)
{
        <span class="keywordtype">int</span> err;
        <a name="a29"></a><a class="code" href="group___p_c_m.html#ga902b87281c46910b469d5f7aaafc1890">snd_pcm_status_t</a> *status;

        <a name="a30"></a><a class="code" href="group___p_c_m___status.html#ga046c09e5d14b684d9fefd70a12cdde1a" title="allocate an invalid snd_pcm_status_t using standard alloca">snd_pcm_status_alloca</a>(&amp;status);
        <span class="keywordflow">if</span> ((err = <a name="a31"></a><a class="code" href="group___p_c_m.html#ga32891eaac37741728a9b23027012c892" title="Obtain status (runtime) information for PCM handle.">snd_pcm_status</a>(handle, status)) &lt; 0) {
                printf(<span class="stringliteral">&quot;Stream status error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                exit(0);
        }
        printf(<span class="stringliteral">&quot;*** frames = %li ***\n&quot;</span>, (<span class="keywordtype">long</span>)frames);
        <a name="a32"></a><a class="code" href="group___p_c_m___dump.html#gaf2427b186609ad502666273342467a51" title="Dump status.">snd_pcm_status_dump</a>(status, output);
}

<span class="keywordtype">void</span> showlatency(<span class="keywordtype">size_t</span> latency)
{
        <span class="keywordtype">double</span> d;
        latency *= 2;
        d = (double)latency / (<span class="keywordtype">double</span>)rate;
        printf(<span class="stringliteral">&quot;Trying latency %li frames, %.3fus, %.6fms (%.4fHz)\n&quot;</span>, (<span class="keywordtype">long</span>)latency, d * 1000000, d * 1000, (<span class="keywordtype">double</span>)1 / d);
}

<span class="keywordtype">void</span> showinmax(<span class="keywordtype">size_t</span> in_max)
{
        <span class="keywordtype">double</span> d;

        printf(<span class="stringliteral">&quot;Maximum read: %li frames\n&quot;</span>, (<span class="keywordtype">long</span>)in_max);
        d = (double)in_max / (<span class="keywordtype">double</span>)rate;
        printf(<span class="stringliteral">&quot;Maximum read latency: %.3fus, %.6fms (%.4fHz)\n&quot;</span>, d * 1000000, d * 1000, (<span class="keywordtype">double</span>)1 / d);
}

<span class="keywordtype">void</span> gettimestamp(<a class="code" href="group___p_c_m.html#ga919e634deecd855b6e2e15174e70d3ea">snd_pcm_t</a> *handle, <a name="a33"></a><a class="code" href="group___global.html#gadd377862d568809fb0e32c9faddf99a4">snd_timestamp_t</a> *timestamp)
{
        <span class="keywordtype">int</span> err;
        <a class="code" href="group___p_c_m.html#ga902b87281c46910b469d5f7aaafc1890">snd_pcm_status_t</a> *status;

        <a class="code" href="group___p_c_m___status.html#ga046c09e5d14b684d9fefd70a12cdde1a" title="allocate an invalid snd_pcm_status_t using standard alloca">snd_pcm_status_alloca</a>(&amp;status);
        <span class="keywordflow">if</span> ((err = <a class="code" href="group___p_c_m.html#ga32891eaac37741728a9b23027012c892" title="Obtain status (runtime) information for PCM handle.">snd_pcm_status</a>(handle, status)) &lt; 0) {
                printf(<span class="stringliteral">&quot;Stream status error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                exit(0);
        }
        <a name="a34"></a><a class="code" href="group___p_c_m___status.html#ga5eaeff98814e96c2ffd5f04c95b22c8d" title="Get trigger timestamp from a PCM status container.">snd_pcm_status_get_trigger_tstamp</a>(status, timestamp);
}

<span class="keywordtype">void</span> setscheduler(<span class="keywordtype">void</span>)
{
        <span class="keyword">struct </span>sched_param sched_param;

        <span class="keywordflow">if</span> (sched_getparam(0, &amp;sched_param) &lt; 0) {
                printf(<span class="stringliteral">&quot;Scheduler getparam failed...\n&quot;</span>);
                <span class="keywordflow">return</span>;
        }
        sched_param.sched_priority = sched_get_priority_max(SCHED_RR);
        <span class="keywordflow">if</span> (!sched_setscheduler(0, SCHED_RR, &amp;sched_param)) {
                printf(<span class="stringliteral">&quot;Scheduler set to Round Robin with priority %i...\n&quot;</span>, sched_param.sched_priority);
                fflush(stdout);
                <span class="keywordflow">return</span>;
        }
        printf(<span class="stringliteral">&quot;!!!Scheduler set to Round Robin with priority %i FAILED!!!\n&quot;</span>, sched_param.sched_priority);
}

<span class="keywordtype">long</span> timediff(<a class="code" href="group___global.html#gadd377862d568809fb0e32c9faddf99a4">snd_timestamp_t</a> t1, <a class="code" href="group___global.html#gadd377862d568809fb0e32c9faddf99a4">snd_timestamp_t</a> t2)
{
        <span class="keywordtype">signed</span> <span class="keywordtype">long</span> l;

        t1.tv_sec -= t2.tv_sec;
        l = (<span class="keywordtype">signed</span> long) t1.tv_usec - (<span class="keywordtype">signed</span> <span class="keywordtype">long</span>) t2.tv_usec;
        <span class="keywordflow">if</span> (l &lt; 0) {
                t1.tv_sec--;
                l = -l;
                l %= 1000000;
        }
        <span class="keywordflow">return</span> (t1.tv_sec * 1000000) + l;
}

<span class="keywordtype">long</span> readbuf(<a class="code" href="group___p_c_m.html#ga919e634deecd855b6e2e15174e70d3ea">snd_pcm_t</a> *handle, <span class="keywordtype">char</span> *buf, <span class="keywordtype">long</span> len, <span class="keywordtype">size_t</span> *frames, <span class="keywordtype">size_t</span> *max)
{
        <span class="keywordtype">long</span> r;

        <span class="keywordflow">if</span> (!block) {
                <span class="keywordflow">do</span> {
                        r = <a name="a35"></a><a class="code" href="group___p_c_m.html#ga4c2c7bd26cf221268d59dc3bbeb9c048" title="Read interleaved frames from a PCM.">snd_pcm_readi</a>(handle, buf, len);
                } <span class="keywordflow">while</span> (r == -EAGAIN);
                <span class="keywordflow">if</span> (r &gt; 0) {
                        *frames += r;
                        <span class="keywordflow">if</span> ((<span class="keywordtype">long</span>)*max &lt; r)
                                *max = r;
                }
                <span class="comment">// printf(&quot;read = %li\n&quot;, r);</span>
        } <span class="keywordflow">else</span> {
                <span class="keywordtype">int</span> frame_bytes = (<a name="a36"></a><a class="code" href="group___p_c_m___helpers.html#ga8d4e07f2d68cc16f607857ed8a222a29" title="Return nominal bits per a PCM sample.">snd_pcm_format_width</a>(format) / 8) * channels;
                <span class="keywordflow">do</span> {
                        r = <a class="code" href="group___p_c_m.html#ga4c2c7bd26cf221268d59dc3bbeb9c048" title="Read interleaved frames from a PCM.">snd_pcm_readi</a>(handle, buf, len);
                        <span class="keywordflow">if</span> (r &gt; 0) {
                                buf += r * frame_bytes;
                                len -= r;
                                *frames += r;
                                <span class="keywordflow">if</span> ((<span class="keywordtype">long</span>)*max &lt; r)
                                        *max = r;
                        }
                        <span class="comment">// printf(&quot;r = %li, len = %li\n&quot;, r, len);</span>
                } <span class="keywordflow">while</span> (r &gt;= 1 &amp;&amp; len &gt; 0);
        }
        <span class="comment">// showstat(handle, 0);</span>
        <span class="keywordflow">return</span> r;
}

<span class="keywordtype">long</span> writebuf(<a class="code" href="group___p_c_m.html#ga919e634deecd855b6e2e15174e70d3ea">snd_pcm_t</a> *handle, <span class="keywordtype">char</span> *buf, <span class="keywordtype">long</span> len, <span class="keywordtype">size_t</span> *frames)
{
        <span class="keywordtype">long</span> r;

        <span class="keywordflow">while</span> (len &gt; 0) {
                r = <a name="a37"></a><a class="code" href="group___p_c_m.html#gabc748a500743713eafa960c7d104ca6f" title="Write interleaved frames to a PCM.">snd_pcm_writei</a>(handle, buf, len);
                <span class="keywordflow">if</span> (r == -EAGAIN)
                        <span class="keywordflow">continue</span>;
                <span class="comment">// printf(&quot;write = %li\n&quot;, r);</span>
                <span class="keywordflow">if</span> (r &lt; 0)
                        <span class="keywordflow">return</span> r;
                <span class="comment">// showstat(handle, 0);</span>
                buf += r * 4;
                len -= r;
                *frames += r;
        }
        <span class="keywordflow">return</span> 0;
}
                        
<span class="preprocessor">#define FILTERSWEEP_LFO_CENTER 2000.</span>
<span class="preprocessor"></span><span class="preprocessor">#define FILTERSWEEP_LFO_DEPTH 1800.</span>
<span class="preprocessor"></span><span class="preprocessor">#define FILTERSWEEP_LFO_FREQ 0.2</span>
<span class="preprocessor"></span><span class="preprocessor">#define FILTER_BANDWIDTH 50</span>
<span class="preprocessor"></span>
<span class="comment">/* filter the sweep variables */</span>
<span class="keywordtype">float</span> lfo,dlfo,fs,fc,BW,C,D,a0,a1,a2,b1,b2,*x[3],*y[3];

<span class="keywordtype">void</span> applyeffect(<span class="keywordtype">char</span>* buffer,<span class="keywordtype">int</span> r)
{
        <span class="keywordtype">short</span>* samples = (<span class="keywordtype">short</span>*) buffer;
        <span class="keywordtype">int</span> i;
        <span class="keywordflow">for</span> (i=0;i&lt;r;i++)
        {
                <span class="keywordtype">int</span> chn;

                fc = sin(lfo)*FILTERSWEEP_LFO_DEPTH+FILTERSWEEP_LFO_CENTER;
                lfo += dlfo;
                <span class="keywordflow">if</span> (lfo&gt;2.*M_PI) lfo -= 2.*M_PI;
                C = 1./tan(M_PI*BW/fs);
                D = 2.*cos(2*M_PI*fc/fs);
                a0 = 1./(1.+C);
                a1 = 0;
                a2 = -a0;
                b1 = -C*D*a0;
                b2 = (C-1)*a0;

                <span class="keywordflow">for</span> (chn=0;chn&lt;channels;chn++)
                {
                        x[chn][2] = x[chn][1];
                        x[chn][1] = x[chn][0];

                        y[chn][2] = y[chn][1];
                        y[chn][1] = y[chn][0];

                        x[chn][0] = samples[i*channels+chn];
                        y[chn][0] = a0*x[chn][0] + a1*x[chn][1] + a2*x[chn][2] 
                                - b1*y[chn][1] - b2*y[chn][2];
                        samples[i*channels+chn] = y[chn][0];
                }
        }
}

<span class="keywordtype">void</span> help(<span class="keywordtype">void</span>)
{
        <span class="keywordtype">int</span> k;
        printf(
<span class="stringliteral">&quot;Usage: latency [OPTION]... [FILE]...\n&quot;</span>
<span class="stringliteral">&quot;-h,--help      help\n&quot;</span>
<span class="stringliteral">&quot;-P,--pdevice   playback device\n&quot;</span>
<span class="stringliteral">&quot;-C,--cdevice   capture device\n&quot;</span>
<span class="stringliteral">&quot;-m,--min       minimum latency in frames\n&quot;</span>
<span class="stringliteral">&quot;-M,--max       maximum latency in frames\n&quot;</span>
<span class="stringliteral">&quot;-F,--frames    frames to transfer\n&quot;</span>
<span class="stringliteral">&quot;-f,--format    sample format\n&quot;</span>
<span class="stringliteral">&quot;-c,--channels  channels\n&quot;</span>
<span class="stringliteral">&quot;-r,--rate      rate\n&quot;</span>
<span class="stringliteral">&quot;-B,--buffer    buffer size in frames\n&quot;</span>
<span class="stringliteral">&quot;-E,--period    period size in frames\n&quot;</span>
<span class="stringliteral">&quot;-s,--seconds   duration of test in seconds\n&quot;</span>
<span class="stringliteral">&quot;-b,--block     block mode\n&quot;</span>
<span class="stringliteral">&quot;-p,--poll      use poll (wait for event - reduces CPU usage)\n&quot;</span>
<span class="stringliteral">&quot;-e,--effect    apply an effect (bandpass filter sweep)\n&quot;</span>
);
        printf(<span class="stringliteral">&quot;Recognized sample formats are:&quot;</span>);
        <span class="keywordflow">for</span> (k = 0; k &lt; SND_PCM_FORMAT_LAST; ++k) {
                <span class="keyword">const</span> <span class="keywordtype">char</span> *s = <a name="a38"></a><a class="code" href="group___p_c_m___description.html#ga2ca258b8ac569ca35f283e48d2181e45" title="get name of PCM sample format">snd_pcm_format_name</a>(k);
                <span class="keywordflow">if</span> (s)
                        printf(<span class="stringliteral">&quot; %s&quot;</span>, s);
        }
        printf(<span class="stringliteral">&quot;\n\n&quot;</span>);
        printf(
<span class="stringliteral">&quot;Tip #1 (usable latency with large periods, non-blocking mode, good CPU usage,\n&quot;</span>
<span class="stringliteral">&quot;        superb xrun prevention):\n&quot;</span>
<span class="stringliteral">&quot;  latency -m 8192 -M 8192 -t 1 -p\n&quot;</span>
<span class="stringliteral">&quot;Tip #2 (superb latency, non-blocking mode, but heavy CPU usage):\n&quot;</span>
<span class="stringliteral">&quot;  latency -m 128 -M 128\n&quot;</span>
);
}

<span class="keywordtype">int</span> main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
{
        <span class="keyword">struct </span>option long_option[] =
        {
                {<span class="stringliteral">&quot;help&quot;</span>, 0, NULL, <span class="charliteral">&apos;h&apos;</span>},
                {<span class="stringliteral">&quot;pdevice&quot;</span>, 1, NULL, <span class="charliteral">&apos;P&apos;</span>},
                {<span class="stringliteral">&quot;cdevice&quot;</span>, 1, NULL, <span class="charliteral">&apos;C&apos;</span>},
                {<span class="stringliteral">&quot;min&quot;</span>, 1, NULL, <span class="charliteral">&apos;m&apos;</span>},
                {<span class="stringliteral">&quot;max&quot;</span>, 1, NULL, <span class="charliteral">&apos;M&apos;</span>},
                {<span class="stringliteral">&quot;frames&quot;</span>, 1, NULL, <span class="charliteral">&apos;F&apos;</span>},
                {<span class="stringliteral">&quot;format&quot;</span>, 1, NULL, <span class="charliteral">&apos;f&apos;</span>},
                {<span class="stringliteral">&quot;channels&quot;</span>, 1, NULL, <span class="charliteral">&apos;c&apos;</span>},
                {<span class="stringliteral">&quot;rate&quot;</span>, 1, NULL, <span class="charliteral">&apos;r&apos;</span>},
                {<span class="stringliteral">&quot;buffer&quot;</span>, 1, NULL, <span class="charliteral">&apos;B&apos;</span>},
                {<span class="stringliteral">&quot;period&quot;</span>, 1, NULL, <span class="charliteral">&apos;E&apos;</span>},
                {<span class="stringliteral">&quot;seconds&quot;</span>, 1, NULL, <span class="charliteral">&apos;s&apos;</span>},
                {<span class="stringliteral">&quot;block&quot;</span>, 0, NULL, <span class="charliteral">&apos;b&apos;</span>},
                {<span class="stringliteral">&quot;poll&quot;</span>, 0, NULL, <span class="charliteral">&apos;p&apos;</span>},
                {<span class="stringliteral">&quot;effect&quot;</span>, 0, NULL, <span class="charliteral">&apos;e&apos;</span>},
                {NULL, 0, NULL, 0},
        };
        <a class="code" href="group___p_c_m.html#ga919e634deecd855b6e2e15174e70d3ea">snd_pcm_t</a> *phandle, *chandle;
        <span class="keywordtype">char</span> *buffer;
        <span class="keywordtype">int</span> err, latency, morehelp;
        <span class="keywordtype">int</span> ok;
        <a class="code" href="group___global.html#gadd377862d568809fb0e32c9faddf99a4">snd_timestamp_t</a> p_tstamp, c_tstamp;
        ssize_t r;
        <span class="keywordtype">size_t</span> frames_in, frames_out, in_max;
        <span class="keywordtype">int</span> effect = 0;
        morehelp = 0;
        <span class="keywordflow">while</span> (1) {
                <span class="keywordtype">int</span> c;
                <span class="keywordflow">if</span> ((c = getopt_long(argc, argv, <span class="stringliteral">&quot;hP:C:m:M:F:f:c:r:s:bpen&quot;</span>, long_option, NULL)) &lt; 0)
                        <span class="keywordflow">break</span>;
                <span class="keywordflow">switch</span> (c) {
                <span class="keywordflow">case</span> <span class="charliteral">&apos;h&apos;</span>:
                        morehelp++;
                        <span class="keywordflow">break</span>;
                <span class="keywordflow">case</span> <span class="charliteral">&apos;P&apos;</span>:
                        pdevice = strdup(optarg);
                        <span class="keywordflow">break</span>;
                <span class="keywordflow">case</span> <span class="charliteral">&apos;C&apos;</span>:
                        cdevice = strdup(optarg);
                        <span class="keywordflow">break</span>;
                <span class="keywordflow">case</span> <span class="charliteral">&apos;m&apos;</span>:
                        err = atoi(optarg) / 2;
                        latency_min = err &gt;= 4 ? err : 4;
                        <span class="keywordflow">if</span> (latency_max &lt; latency_min)
                                latency_max = latency_min;
                        <span class="keywordflow">break</span>;
                <span class="keywordflow">case</span> <span class="charliteral">&apos;M&apos;</span>:
                        err = atoi(optarg) / 2;
                        latency_max = latency_min &gt; err ? latency_min : err;
                        <span class="keywordflow">break</span>;
                <span class="keywordflow">case</span> <span class="charliteral">&apos;f&apos;</span>:
                        format = <a name="a39"></a><a class="code" href="group___p_c_m___description.html#ga59f99dd9647315a7312d1f2b6204b7bc" title="get PCM sample format from name">snd_pcm_format_value</a>(optarg);
                        <span class="keywordflow">if</span> (format == <a name="a40"></a><a class="code" href="group___p_c_m.html#ggaa14b7f26877a812acbb39811364177f8ab1e118ecdccf628639b5c85bc3a48999">SND_PCM_FORMAT_UNKNOWN</a>) {
                                printf(<span class="stringliteral">&quot;Unknown format, setting to default S16_LE\n&quot;</span>);
                                format = <a class="code" href="group___p_c_m.html#ggaa14b7f26877a812acbb39811364177f8a8b66a29293c62df9d1678c609fab76c0">SND_PCM_FORMAT_S16_LE</a>;
                        }
                        <span class="keywordflow">break</span>;
                <span class="keywordflow">case</span> <span class="charliteral">&apos;c&apos;</span>:
                        err = atoi(optarg);
                        channels = err &gt;= 1 &amp;&amp; err &lt; 1024 ? err : 1;
                        <span class="keywordflow">break</span>;
                <span class="keywordflow">case</span> <span class="charliteral">&apos;r&apos;</span>:
                        err = atoi(optarg);
                        rate = err &gt;= 4000 &amp;&amp; err &lt; 200000 ? err : 44100;
                        <span class="keywordflow">break</span>;
                <span class="keywordflow">case</span> <span class="charliteral">&apos;B&apos;</span>:
                        err = atoi(optarg);
                        buffer_size = err &gt;= 32 &amp;&amp; err &lt; 200000 ? err : 0;
                        <span class="keywordflow">break</span>;
                <span class="keywordflow">case</span> <span class="charliteral">&apos;E&apos;</span>:
                        err = atoi(optarg);
                        period_size = err &gt;= 32 &amp;&amp; err &lt; 200000 ? err : 0;
                        <span class="keywordflow">break</span>;
                <span class="keywordflow">case</span> <span class="charliteral">&apos;s&apos;</span>:
                        err = atoi(optarg);
                        loop_sec = err &gt;= 1 &amp;&amp; err &lt;= 100000 ? err : 30;
                        <span class="keywordflow">break</span>;
                <span class="keywordflow">case</span> <span class="charliteral">&apos;b&apos;</span>:
                        block = 1;
                        <span class="keywordflow">break</span>;
                <span class="keywordflow">case</span> <span class="charliteral">&apos;p&apos;</span>:
                        use_poll = 1;
                        <span class="keywordflow">break</span>;
                <span class="keywordflow">case</span> <span class="charliteral">&apos;e&apos;</span>:
                        effect = 1;
                        <span class="keywordflow">break</span>;
                <span class="keywordflow">case</span> <span class="charliteral">&apos;n&apos;</span>:
                        resample = 0;
                        <span class="keywordflow">break</span>;
                }
        }

        <span class="keywordflow">if</span> (morehelp) {
                help();
                <span class="keywordflow">return</span> 0;
        }
        err = <a name="a41"></a><a class="code" href="group___output.html#gaca78d01bf6d081274650794861373c7d" title="Creates a new output object using an existing stdio FILE pointer.">snd_output_stdio_attach</a>(&amp;output, stdout, 0);
        <span class="keywordflow">if</span> (err &lt; 0) {
                printf(<span class="stringliteral">&quot;Output failed: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                <span class="keywordflow">return</span> 0;
        }

        loop_limit = loop_sec * rate;
        latency = latency_min - 4;
        buffer = malloc((latency_max * <a class="code" href="group___p_c_m___helpers.html#ga8d4e07f2d68cc16f607857ed8a222a29" title="Return nominal bits per a PCM sample.">snd_pcm_format_width</a>(format) / 8) * 2);

        setscheduler();

        printf(<span class="stringliteral">&quot;Playback device is %s\n&quot;</span>, pdevice);
        printf(<span class="stringliteral">&quot;Capture device is %s\n&quot;</span>, cdevice);
        printf(<span class="stringliteral">&quot;Parameters are %iHz, %s, %i channels, %s mode\n&quot;</span>, rate, <a class="code" href="group___p_c_m___description.html#ga2ca258b8ac569ca35f283e48d2181e45" title="get name of PCM sample format">snd_pcm_format_name</a>(format), channels, block ? <span class="stringliteral">&quot;blocking&quot;</span> : <span class="stringliteral">&quot;non-blocking&quot;</span>);
        printf(<span class="stringliteral">&quot;Poll mode: %s\n&quot;</span>, use_poll ? <span class="stringliteral">&quot;yes&quot;</span> : <span class="stringliteral">&quot;no&quot;</span>);
        printf(<span class="stringliteral">&quot;Loop limit is %li frames, minimum latency = %i, maximum latency = %i\n&quot;</span>, loop_limit, latency_min * 2, latency_max * 2);

        <span class="keywordflow">if</span> ((err = <a name="a42"></a><a class="code" href="group___p_c_m.html#ga8340c7dc0ac37f37afe5e7c21d6c528b" title="Opens a PCM.">snd_pcm_open</a>(&amp;phandle, pdevice, <a name="a43"></a><a class="code" href="group___p_c_m.html#ggac23b43ff55add78638e503b9cc892c24a57a2b920dbc34173479fc9036cfc78a1">SND_PCM_STREAM_PLAYBACK</a>, block ? 0 : <a name="a44"></a><a class="code" href="group___p_c_m.html#ga6bd90de1d1527b5804090dcce51079ad">SND_PCM_NONBLOCK</a>)) &lt; 0) {
                printf(<span class="stringliteral">&quot;Playback open error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                <span class="keywordflow">return</span> 0;
        }
        <span class="keywordflow">if</span> ((err = <a class="code" href="group___p_c_m.html#ga8340c7dc0ac37f37afe5e7c21d6c528b" title="Opens a PCM.">snd_pcm_open</a>(&amp;chandle, cdevice, <a name="a45"></a><a class="code" href="group___p_c_m.html#ggac23b43ff55add78638e503b9cc892c24af07834f756b4f95cb61987f4811073c4">SND_PCM_STREAM_CAPTURE</a>, block ? 0 : SND_PCM_NONBLOCK)) &lt; 0) {
                printf(<span class="stringliteral">&quot;Record open error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                <span class="keywordflow">return</span> 0;
        }

        <span class="comment">/* initialize the filter sweep variables */</span>
        <span class="keywordflow">if</span> (effect) {
                fs = (float) rate;
                BW = FILTER_BANDWIDTH;

                lfo = 0;
                dlfo = 2.*M_PI*FILTERSWEEP_LFO_FREQ/fs;

                x[0] = (<span class="keywordtype">float</span>*) malloc(channels*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));         
                x[1] = (<span class="keywordtype">float</span>*) malloc(channels*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));         
                x[2] = (<span class="keywordtype">float</span>*) malloc(channels*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));         
                y[0] = (<span class="keywordtype">float</span>*) malloc(channels*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));         
                y[1] = (<span class="keywordtype">float</span>*) malloc(channels*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));         
                y[2] = (<span class="keywordtype">float</span>*) malloc(channels*<span class="keyword">sizeof</span>(<span class="keywordtype">float</span>));         
        }
                          
        <span class="keywordflow">while</span> (1) {
                frames_in = frames_out = 0;
                <span class="keywordflow">if</span> (setparams(phandle, chandle, &amp;latency) &lt; 0)
                        <span class="keywordflow">break</span>;
                showlatency(latency);
                <span class="keywordflow">if</span> ((err = <a name="a46"></a><a class="code" href="group___p_c_m.html#gac6c33091b049985baa6466e8fe93917e" title="Link two PCMs.">snd_pcm_link</a>(chandle, phandle)) &lt; 0) {
                        printf(<span class="stringliteral">&quot;Streams link error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                        exit(0);
                }
                <span class="keywordflow">if</span> (<a name="a47"></a><a class="code" href="group___p_c_m___helpers.html#ga82631361cf1c1d13af207beb59cf97ac" title="Silence a PCM samples buffer.">snd_pcm_format_set_silence</a>(format, buffer, latency*channels) &lt; 0) {
                        fprintf(stderr, <span class="stringliteral">&quot;silence error\n&quot;</span>);
                        <span class="keywordflow">break</span>;
                }
                <span class="keywordflow">if</span> (writebuf(phandle, buffer, latency, &amp;frames_out) &lt; 0) {
                        fprintf(stderr, <span class="stringliteral">&quot;write error\n&quot;</span>);
                        <span class="keywordflow">break</span>;
                }
                <span class="keywordflow">if</span> (writebuf(phandle, buffer, latency, &amp;frames_out) &lt; 0) {
                        fprintf(stderr, <span class="stringliteral">&quot;write error\n&quot;</span>);
                        <span class="keywordflow">break</span>;
                }

                <span class="keywordflow">if</span> ((err = <a name="a48"></a><a class="code" href="group___p_c_m.html#ga6bdb88b68a9d9e66015d770f600c6aea" title="Start a PCM.">snd_pcm_start</a>(chandle)) &lt; 0) {
                        printf(<span class="stringliteral">&quot;Go error: %s\n&quot;</span>, <a class="code" href="group___error.html#ga182bbadf2349e11602bc531e8cf22f7e" title="Returns the message for an error code.">snd_strerror</a>(err));
                        exit(0);
                }
                gettimestamp(phandle, &amp;p_tstamp);
                gettimestamp(chandle, &amp;c_tstamp);
<span class="preprocessor">#if 0</span>
<span class="preprocessor"></span>                printf(<span class="stringliteral">&quot;Playback:\n&quot;</span>);
                showstat(phandle, frames_out);
                printf(<span class="stringliteral">&quot;Capture:\n&quot;</span>);
                showstat(chandle, frames_in);
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>
                ok = 1;
                in_max = 0;
                <span class="keywordflow">while</span> (ok &amp;&amp; frames_in &lt; loop_limit) {
                        <span class="keywordflow">if</span> (use_poll) {
                                <span class="comment">/* use poll to wait for next event */</span>
                                <a name="a49"></a><a class="code" href="group___p_c_m.html#gad4d53d58b996a7cd9a5cbf1710b90375" title="Wait for a PCM to become ready.">snd_pcm_wait</a>(chandle, 1000);
                        }
                        <span class="keywordflow">if</span> ((r = readbuf(chandle, buffer, latency, &amp;frames_in, &amp;in_max)) &lt; 0)
                                ok = 0;
                        <span class="keywordflow">else</span> {
                                <span class="keywordflow">if</span> (effect)
                                        applyeffect(buffer,r);
                                <span class="keywordflow">if</span> (writebuf(phandle, buffer, r, &amp;frames_out) &lt; 0)
                                        ok = 0;
                        }
                }
                <span class="keywordflow">if</span> (ok)
                        printf(<span class="stringliteral">&quot;Success\n&quot;</span>);
                <span class="keywordflow">else</span>
                        printf(<span class="stringliteral">&quot;Failure\n&quot;</span>);
                printf(<span class="stringliteral">&quot;Playback:\n&quot;</span>);
                showstat(phandle, frames_out);
                printf(<span class="stringliteral">&quot;Capture:\n&quot;</span>);
                showstat(chandle, frames_in);
                showinmax(in_max);
                <span class="keywordflow">if</span> (p_tstamp.tv_sec == p_tstamp.tv_sec &amp;&amp;
                    p_tstamp.tv_usec == c_tstamp.tv_usec)
                        printf(<span class="stringliteral">&quot;Hardware sync\n&quot;</span>);
                <a name="a50"></a><a class="code" href="group___p_c_m.html#ga7000ca6010a1a2739daddff8e2fbb440" title="Stop a PCM dropping pending frames.">snd_pcm_drop</a>(chandle);
                <a name="a51"></a><a class="code" href="group___p_c_m.html#ga8d9ed4a62c17402de0389fd31fc7dc1f" title="set nonblock mode">snd_pcm_nonblock</a>(phandle, 0);
                <a name="a52"></a><a class="code" href="group___p_c_m.html#ga49afc5b8527f30c33fafa476533c9f86" title="Stop a PCM preserving pending frames.">snd_pcm_drain</a>(phandle);
                <a class="code" href="group___p_c_m.html#ga8d9ed4a62c17402de0389fd31fc7dc1f" title="set nonblock mode">snd_pcm_nonblock</a>(phandle, !block ? 1 : 0);
                <span class="keywordflow">if</span> (ok) {
<span class="preprocessor">#if 1</span>
<span class="preprocessor"></span>                        printf(<span class="stringliteral">&quot;Playback time = %li.%i, Record time = %li.%i, diff = %li\n&quot;</span>,
                               p_tstamp.tv_sec,
                               (<span class="keywordtype">int</span>)p_tstamp.tv_usec,
                               c_tstamp.tv_sec,
                               (<span class="keywordtype">int</span>)c_tstamp.tv_usec,
                               timediff(p_tstamp, c_tstamp));
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>                        <span class="keywordflow">break</span>;
                }
                <a name="a53"></a><a class="code" href="group___p_c_m.html#ga0d3af5e30593dae857b4308aab5035cd" title="Remove a PCM from a linked group.">snd_pcm_unlink</a>(chandle);
                <a name="a54"></a><a class="code" href="group___p_c_m.html#ga242ad0a269c272830d30666220edbc2a" title="Remove PCM hardware configuration and free associated resources.">snd_pcm_hw_free</a>(phandle);
                <a class="code" href="group___p_c_m.html#ga242ad0a269c272830d30666220edbc2a" title="Remove PCM hardware configuration and free associated resources.">snd_pcm_hw_free</a>(chandle);
        }
        <a name="a55"></a><a class="code" href="group___p_c_m.html#ga042aba7262a4cbb4d444b6fc08cb7124" title="close PCM handle">snd_pcm_close</a>(phandle);
        <a class="code" href="group___p_c_m.html#ga042aba7262a4cbb4d444b6fc08cb7124" title="close PCM handle">snd_pcm_close</a>(chandle);
        <span class="keywordflow">return</span> 0;
}
</pre></div> </div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr size="1"><address style="text-align: right;"><small>
Generated for ALSA project - the C library reference by&nbsp;<a href="http://www.doxygen.org/
index.html"><img src="doxygen.png" alt="doxygen" align="middle" border="0"></a>
1.6.1</small></address>
</body>
</html>
