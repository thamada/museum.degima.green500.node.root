From cea1f75e30d03f02c3b14b9ab9bbe313efcd8d76 Mon Sep 17 00:00:00 2001
From: Ali Ayoub <ali@mellanox.com>
Date: Fri, 10 Dec 2010 11:11:55 -0800
Subject: [PATCH] mlx4: bugfix: avoid vunmpa invalid pointer in allocation bad flow

Signed-off-by: Ali Ayoub <ali@mellanox.com>
(cherry picked from commit 58d180731b22f9483288800cea8a8d6381c48c61)
---
 drivers/net/mlx4/alloc.c |    3 ++-
 1 files changed, 2 insertions(+), 1 deletions(-)

diff --git a/drivers/net/mlx4/alloc.c b/drivers/net/mlx4/alloc.c
index ad95d5f..44a64f0 100644
--- a/drivers/net/mlx4/alloc.c
+++ b/drivers/net/mlx4/alloc.c
@@ -214,6 +214,7 @@ int mlx4_buf_alloc(struct mlx4_dev *dev, int size, int max_direct,
 	} else {
 		int i;
 
+		buf->direct.buf  = NULL;
 		buf->nbufs       = (size + PAGE_SIZE - 1) / PAGE_SIZE;
 		buf->npages      = buf->nbufs;
 		buf->page_shift  = PAGE_SHIFT;
@@ -265,7 +266,7 @@ void mlx4_buf_free(struct mlx4_dev *dev, int size, struct mlx4_buf *buf)
 		dma_free_coherent(&dev->pdev->dev, size, buf->direct.buf,
 				  buf->direct.map);
 	else {
-		if (BITS_PER_LONG == 64)
+		if (BITS_PER_LONG == 64 && buf->direct.buf)
 			vunmap(buf->direct.buf);
 
 		for (i = 0; i < buf->nbufs; ++i)
-- 
1.7.0.4

