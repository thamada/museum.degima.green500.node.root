---
 drivers/infiniband/core/sysfs.c |   24 +++++++++++++++++++++---
 1 file changed, 21 insertions(+), 3 deletions(-)

Index: ofed_kernel/drivers/infiniband/core/sysfs.c
===================================================================
--- ofed_kernel.orig/drivers/infiniband/core/sysfs.c
+++ ofed_kernel/drivers/infiniband/core/sysfs.c
@@ -432,18 +432,36 @@ static void ib_device_release(struct cla
 	kfree(dev);
 }
 
-static int ib_device_uevent(struct class_device *cdev,
-			    struct kobj_uevent_env *env)
+static int ib_device_uevent(struct class_device *cdev, char **envp,
+			    int num_envp, char *buf, int size)
 {
 	struct ib_device *dev = container_of(cdev, struct ib_device, class_dev);
+	int i = 0;
+#ifndef HOTPLUG_ENV_VAR
+#define HOTPLUG_ENV_VAR(_buf, _size, _envp, _nenvp, _index, _fmt, _arg...) \
+	({								\
+		int len, ret = 0;					\
+		_envp[_index++] = _buf;					\
+		len = snprintf(_buf, _size, _fmt, ## _arg);		\
+		if (_size - len <= 0 || _index >= _nenvp)		\
+			ret = -ENOMEM;					\
+		else {							\
+			_buf  += len + 1;				\
+			_size -= len + 1;				\
+		}							\
+		ret;							\
+	})
+#endif
 
-	if (add_uevent_var(env, "NAME=%s", dev->name))
+	if (HOTPLUG_ENV_VAR(buf, size, envp, num_envp, i,
+			   "NAME=%s", dev->name))
 		return -ENOMEM;
 
 	/*
 	 * It would be nice to pass the node GUID with the event...
 	 */
 
+	envp[i] = NULL;
 	return 0;
 }
 
