From 5a9fd2300982aca58f1306bdb98cab878998a607 Mon Sep 17 00:00:00 2001
From: Doron Shoham <dorons@voltaire.com>
Date: Sun, 6 Jul 2008 15:53:59 +0300
Subject: [PATCH] fix iscsi_free_mgmt_task

Signed-off-by: Doron Shoham <dorons@voltaire.com>
---
 drivers/infiniband/ulp/iser/iser_initiator.c |    4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

Index: ofed_kernel/drivers/infiniband/ulp/iser/iser_initiator.c
===================================================================
--- ofed_kernel.orig/drivers/infiniband/ulp/iser/iser_initiator.c
+++ ofed_kernel/drivers/infiniband/ulp/iser/iser_initiator.c
@@ -627,7 +627,9 @@ void iser_snd_completion(struct iser_des
 			struct iscsi_session *session = conn->session;
 
 			spin_lock(&conn->session->lock);
-			iscsi_free_mgmt_task(conn, mtask);
+			list_del(&mtask->running);
+			__kfifo_put(session->mgmtpool.queue, (void*)&mtask,
+				    sizeof(void*));
 			spin_unlock(&session->lock);
 		}
 	}
